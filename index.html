<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Saint Vincent Ferrer - Ultimate Life Journey</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; position: fixed; font-family: 'Georgia', serif; background: #000; }
        canvas { display: block; width: 100% !important; height: 100% !important; position: absolute; top: 0; left: 0; }
        #hud { position: fixed; top: 5px; left: 5px; background: linear-gradient(135deg, rgba(20, 20, 40, 0.95) 0%, rgba(40, 30, 60, 0.95) 100%); padding: 8px; border-radius: 6px; border: 2px solid #d4af37; color: #f0e6d2; font-size: 12px; z-index: 100; max-width: 130px; box-shadow: 0 3px 10px rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        #chapter-title { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, rgba(0, 0, 0, 0.98) 0%, rgba(30, 20, 40, 0.98) 100%); padding: 20px 30px; border: 3px solid #d4af37; border-radius: 8px; color: #d4af37; font-size: 18px; font-weight: bold; text-align: center; z-index: 200; display: none; max-width: 90%; box-shadow: 0 8px 20px rgba(0,0,0,0.9); }
        #dialogue-box { position: fixed; top: 40px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, rgba(20, 20, 40, 0.98) 0%, rgba(40, 30, 60, 0.98) 100%); padding: 13px 17px; border: 2px solid #d4af37; border-radius: 6px; color: #f0e6d2; font-size: 12px; max-width: 90%; z-index: 150; display: none; line-height: 1.6; text-align: center; box-shadow: 0 5px 12px rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        #dialogue-speaker { color: #d4af37; font-weight: bold; font-size: 13px; margin-bottom: 5px; text-align: center; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        #dialogue-text { text-align: center; }
        #dialogue-continue { background: linear-gradient(135deg, #d4af37 0%, #f0d978 100%); color: #1a1a2e; border: none; padding: 5px 13px; margin-top: 7px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; display: block; margin-left: auto; margin-right: auto; box-shadow: 0 2px 4px rgba(212, 175, 55, 0.5); transition: all 0.3s; }
        #dialogue-continue:hover { background: linear-gradient(135deg, #f0d978 0%, #ffd700 100%); transform: translateY(-1px); box-shadow: 0 3px 6px rgba(212, 175, 55, 0.7); }
        #controls { position: fixed; bottom: 8px; left: 8px; background: linear-gradient(135deg, rgba(20, 20, 40, 0.9) 0%, rgba(40, 30, 60, 0.9) 100%); padding: 7px 9px; border-radius: 5px; color: #f0e6d2; font-size: 10px; z-index: 100; text-align: center; box-shadow: 0 3px 6px rgba(0,0,0,0.6); }
        #mobile-joystick { position: fixed; bottom: 10px; left: 10px; width: 70px; height: 70px; display: none; z-index: 200; }
        @media (max-width: 768px), (pointer: coarse) { #mobile-joystick { display: block; } #controls { display: none; } }
        @media (min-width: 1200px) { #hud { font-size: 13px; max-width: 150px; } #dialogue-box { font-size: 13px; } #mission-objective { font-size: 13px; max-width: 150px; } #chapter-title { font-size: 20px; } }
        @media (min-width: 1600px) { #hud { font-size: 15px; max-width: 170px; } #dialogue-box { font-size: 15px; } #mission-objective { font-size: 15px; max-width: 170px; } #chapter-title { font-size: 24px; } }
        .joystick-base { position: absolute; width: 70px; height: 70px; background: radial-gradient(circle, rgba(52, 73, 94, 0.85) 0%, rgba(44, 62, 80, 0.95) 100%); border: 2px solid rgba(212, 175, 55, 0.8); border-radius: 50%; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.7), inset 0 -1px 3px rgba(0,0,0,0.4); }
        .joystick-stick { position: absolute; width: 32px; height: 32px; background: radial-gradient(circle, rgba(212, 175, 55, 1) 0%, rgba(160, 132, 40, 1) 100%); border: 2px solid rgba(160, 132, 40, 1); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: all 0.08s; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.6), inset 0 -1px 3px rgba(0,0,0,0.5); }
        #interact-button { position: fixed; bottom: 15px; right: 15px; width: 35px; height: 35px; background: radial-gradient(circle, rgba(212, 175, 55, 1) 0%, rgba(160, 132, 40, 1) 100%); border: 2px solid rgba(160, 132, 40, 1); border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: white; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6); box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6); z-index: 200; cursor: pointer; }
        @media (max-width: 768px), (pointer: coarse) { #interact-button { display: flex; } }
        #mission-objective { position: fixed; top: 5px; right: 5px; background: linear-gradient(135deg, rgba(20, 20, 40, 0.95) 0%, rgba(40, 30, 60, 0.95) 100%); padding: 8px; border-radius: 6px; border: 2px solid #4a9eff; color: #f0e6d2; font-size: 12px; z-index: 100; max-width: 130px; text-align: center; box-shadow: 0 3px 10px rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        #objective-title { color: #4a9eff; font-weight: bold; margin-bottom: 3px; font-size: 13px; }
        #task-progress { color: #ffd700; font-weight: bold; margin-top: 4px; font-size: 13px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .miracle-effect { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; color: #ffd700; text-shadow: 0 0 15px #fff, 0 0 30px #ffd700, 0 0 45px #ffd700; z-index: 250; pointer-events: none; animation: miraclePulse 2.5s ease-out; font-weight: bold; }
        @keyframes miraclePulse { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0) rotate(-10deg); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1.3) rotate(5deg); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1) rotate(0deg); } }
        #title-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a1a2e 0%, #2d1b4e 50%, #4a2c6e 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 300; color: #d4af37; }
        #title-screen h1 { font-size: 34px; margin-bottom: 13px; text-shadow: 0 0 12px rgba(212,175,55,0.8), 2px 2px 4px rgba(0,0,0,0.9); text-align: center; animation: titleGlow 3s ease-in-out infinite; }
        @keyframes titleGlow { 0%, 100% { text-shadow: 0 0 12px rgba(212,175,55,0.8), 2px 2px 4px rgba(0,0,0,0.9); } 50% { text-shadow: 0 0 20px rgba(212,175,55,1), 2px 2px 4px rgba(0,0,0,0.9); } }
        #title-screen h2 { font-size: 17px; margin-bottom: 20px; color: #f0e6d2; text-align: center; }
        #title-screen p { font-size: 13px; max-width: 85%; margin: 13px; line-height: 1.5; text-align: center; }
        #start-button { background: linear-gradient(135deg, #d4af37 0%, #f0d978 100%); color: #1a1a2e; border: none; padding: 13px 30px; font-size: 17px; font-weight: bold; border-radius: 6px; cursor: pointer; box-shadow: 0 4px 0 #a08428, 0 5px 10px rgba(0,0,0,0.5); transition: all 0.2s; }
        #start-button:hover { background: linear-gradient(135deg, #f0d978 0%, #ffd700 100%); transform: translateY(-2px); box-shadow: 0 6px 0 #a08428, 0 7px 12px rgba(0,0,0,0.6); }
        #start-button:active { transform: translateY(2px); box-shadow: 0 2px 0 #a08428, 0 3px 6px rgba(0,0,0,0.4); }
        #playing-as { position: fixed; top: 35px; left: 5px; background: linear-gradient(135deg, rgba(139, 0, 139, 0.95) 0%, rgba(75, 0, 130, 0.95) 100%); padding: 5px 8px; border-radius: 5px; border: 2px solid #d4af37; color: #ffd700; font-size: 12px; font-weight: bold; z-index: 100; text-align: center; box-shadow: 0 3px 6px rgba(0,0,0,0.6); }
        #next-chapter-button { position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #4a9eff 0%, #6fb1ff 100%); color: white; border: none; padding: 10px 25px; font-size: 16px; font-weight: bold; border-radius: 6px; cursor: pointer; box-shadow: 0 4px 0 #2c5aa0, 0 5px 12px rgba(74, 158, 255, 0.5); z-index: 200; display: none; transition: all 0.2s; }
        #next-chapter-button:hover { background: linear-gradient(135deg, #6fb1ff 0%, #87ceeb 100%); transform: translateX(-50%) translateY(-2px); box-shadow: 0 6px 0 #2c5aa0, 0 7px 15px rgba(74, 158, 255, 0.6); }
        #next-chapter-button:active { transform: translateX(-50%) translateY(2px); box-shadow: 0 2px 0 #2c5aa0, 0 3px 8px rgba(74, 158, 255, 0.4); }
        #door-button { position: fixed; top: 50px; right: 5px; background: linear-gradient(135deg, #ffd700 0%, #f0d978 100%); color: #1a1a2e; border: 3px solid #d4af37; padding: 10px 20px; font-size: 16px; font-weight: bold; border-radius: 6px; cursor: pointer; z-index: 300; box-shadow: 0 4px 10px rgba(212, 175, 55, 0.8); display: none; transition: all 0.3s; text-align: center; animation: doorPulse 2s ease-in-out infinite; }
        @keyframes doorPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        #door-button:hover { background: linear-gradient(135deg, #f0d978 0%, #ffd700 100%); transform: scale(1.1) translateY(-2px); box-shadow: 0 6px 15px rgba(212, 175, 55, 1); }
        #door-button:active { transform: scale(0.95) translateY(1px); box-shadow: 0 2px 5px rgba(212, 175, 55, 0.5); }
        #mini-radar { position: fixed; bottom: 5px; right: 5px; width: 50px; height: 50px; background: radial-gradient(circle, rgba(20, 20, 40, 0.95) 0%, rgba(10, 10, 20, 0.95) 100%); border: 1px solid #4a9eff; border-radius: 50%; z-index: 100; box-shadow: 0 0 8px rgba(74, 158, 255, 0.5), 0 2px 6px rgba(0,0,0,0.6); }
        .radar-player { position: absolute; width: 4px; height: 4px; background: #00ff00; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 4px #00ff00, 0 0 6px #00ff00; animation: playerPulse 1.5s ease-in-out infinite; }
        @keyframes playerPulse { 0%, 100% { box-shadow: 0 0 4px #00ff00, 0 0 6px #00ff00; } 50% { box-shadow: 0 0 6px #00ff00, 0 0 10px #00ff00; } }
        .radar-objective { position: absolute; width: 4px; height: 4px; background: #ffd700; border-radius: 50%; box-shadow: 0 0 4px #ffd700, 0 0 6px #ffd700; animation: radarPulse 1.2s infinite; }
        @keyframes radarPulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.4); opacity: 0.7; } }
        .radar-scan { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: conic-gradient(transparent 0deg, rgba(74, 158, 255, 0.4) 90deg, transparent 90deg); animation: radarScan 4s linear infinite; }
        @keyframes radarScan { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #fps-counter { position: fixed; top: 5px; right: 145px; background: rgba(0,0,0,0.7); color: #00ff00; padding: 3px 6px; border-radius: 3px; font-family: monospace; font-size: 12px; z-index: 100; }
    </style>
</head>
<body>
    <div id="title-screen">
        <h1>‚úùÔ∏è SAINT VINCENT FERRER ‚úùÔ∏è</h1>
        <h2>The Ultimate Life Journey</h2>
        <p>
            "The fear of the Lord is the beginning of wisdom" - Proverbs 9:10<br><br>
            Experience the miraculous life of the great Dominican preacher<br>
            <strong style="color: #d4af37;">Photorealistic Third-Person Action RPG</strong>
        </p>
        <button id="start-button">Begin Sacred Journey</button>
    </div>
    <div id="chapter-title"></div>
    <div id="playing-as">Playing as: Mother Constance</div>
    <div id="fps-counter">FPS: 60</div>
    <div id="hud">
        <div style="text-align: center; border-bottom: 2px solid #d4af37; padding-bottom: 4px; margin-bottom: 4px;"><strong style="font-size: 13px;">Chapter</strong><br><span id="current-chapter" style="color: #d4af37;">Prologue</span></div>
        <div style="text-align: center; margin-top: 4px;"><strong>Location:</strong><br><span id="current-location">Valencia</span></div>
        <div style="text-align: center; margin-top: 4px;"><strong>Year:</strong><br><span id="current-year">1350</span></div>
        <div style="text-align: center; margin-top: 4px; border-top: 2px solid #d4af37; padding-top: 4px;"><strong>Souls Converted:</strong><br><span id="souls-converted" style="color: #ffd700; font-size: 13px; font-weight: bold;">0</span></div>
    </div>
    <div id="mission-objective">
        <div id="objective-title">‚öîÔ∏è Current Mission</div>
        <div id="objective-text">Wait for instructions...</div>
        <div id="task-progress">0 / 0 Tasks</div>
    </div>
    <div id="dialogue-box">
        <div id="dialogue-speaker"></div>
        <div id="dialogue-text"></div>
        <button id="dialogue-continue">Continue ‚Üí</button>
    </div>
    <div id="controls"><strong>WASD:</strong> Move | <strong>Mouse:</strong> Camera | <strong>E:</strong> Tasks | <strong>Door Button:</strong> Doors</div>
    <div id="mobile-joystick"><div class="joystick-base"></div><div class="joystick-stick"></div></div>
    <button id="interact-button">E</button>
    <button id="next-chapter-button">Continue to Next Chapter ‚Üí</button>
    <button id="door-button">üö™ Open Door</button>
    
    <div id="mini-radar">
        <div class="radar-scan"></div>
        <div class="radar-player"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        'use strict';

        // Constants
        const MOVE_SPEED = 12;
        const CAMERA_DISTANCE = 15; // Increased from 12 for much wider view
        const CAMERA_HEIGHT = 8; // Increased from 4 for bird's eye perspective
        const COLLISION_DISTANCE = 1.2; // Reduced from 1.8 for less blocking
        const ANIMATION_SPEED = 8;

        // Chapter definitions with expanded quests
        const CHAPTERS = {
            WOMB_BARKING: {name: "In the Womb - The Barking", year: 1349, location: "Valencia, Spain", playAs: "Mother Constance", tasks: 4, objective: "Experience the miraculous signs"},
            WOMB_HEALING: {name: "In the Womb - Healing the Blind", year: 1349, location: "Valencia, Spain", playAs: "Mother Constance", tasks: 2, objective: "Heal the blind woman and neighbor"},
            BIRTH: {name: "The Miraculous Birth", year: 1350, location: "Valencia, Spain", playAs: "Mother Constance", tasks: 2, objective: "Give birth and witness the light"},
            CHILDHOOD: {name: "Childhood Calling", year: 1360, location: "Valencia", playAs: "Young Vincent", tasks: 4, objective: "Pray, study, help others, talk to father"},
            EDUCATION: {name: "Student Years", year: 1365, location: "University of Lleida", playAs: "Young Vincent", tasks: 5, objective: "Study philosophy, attend lectures, help classmates"},
            DOMINICAN: {name: "Becoming a Dominican", year: 1367, location: "Valencia", playAs: "Saint Vincent Ferrer", tasks: 3, objective: "Take vows, receive habit, meet brothers"},
            PROFESSOR: {name: "Teaching Philosophy", year: 1370, location: "Cathedral of Valencia", playAs: "Saint Vincent Ferrer", tasks: 4, objective: "Teach students, write treatises, debate theology"},
            PEDRO_LUNA: {name: "Cardinal's Confessor", year: 1394, location: "Avignon, France", playAs: "Saint Vincent Ferrer", tasks: 3, objective: "Counsel Cardinal, pray for guidance"},
            PLAGUE: {name: "The Plague Strikes", year: 1398, location: "Avignon", playAs: "Saint Vincent Ferrer", tasks: 4, objective: "Minister to sick, receive last rites, prepare for death"},
            VISION: {name: "Vision of Christ", year: 1398, location: "Heaven", playAs: "Saint Vincent Ferrer", tasks: 5, objective: "Receive divine commission from Trinity"},
            FIRST_MISSION: {name: "First Preaching Journey", year: 1399, location: "Southern France", playAs: "Saint Vincent Ferrer", tasks: 6, objective: "Preach in 6 towns, convert souls"},
            ALLEGIANCE: {name: "Declaration for Benedict XIII", year: 1399, location: "Avignon", playAs: "Saint Vincent Ferrer", tasks: 3, objective: "Declare allegiance, gather support"},
            BISHOPS: {name: "Convincing the Bishops", year: 1400, location: "France", playAs: "Saint Vincent Ferrer", tasks: 5, objective: "Perform miracles to prove Benedict's legitimacy"},
            PREACHING: {name: "The Great Preacher", year: 1400, location: "Europe", playAs: "Saint Vincent Ferrer", tasks: 8, objective: "Preach across Europe, convert thousands"},
            TONGUES: {name: "Gift of Tongues", year: 1403, location: "Brittany", playAs: "Saint Vincent Ferrer", tasks: 4, objective: "Preach in multiple languages miraculously"},
            CHILD_REVIVAL: {name: "Raising Dead Children", year: 1405, location: "Spain", playAs: "Saint Vincent Ferrer", tasks: 4, objective: "Raise 4 dead children to life"},
            SEVERED_HEAD: {name: "The Speaking Head", year: 1407, location: "Barcelona", playAs: "Saint Vincent Ferrer", tasks: 3, objective: "Make severed head speak truth"},
            WINGS: {name: "The Angelic Flight", year: 1405, location: "Barcelona", playAs: "Saint Vincent Ferrer", tasks: 3, objective: "Receive wings, save drowning man, preach"},
            MULTIPLICATION: {name: "Multiplying Food", year: 1410, location: "Castile", playAs: "Saint Vincent Ferrer", tasks: 5, objective: "Feed 5 starving villages"},
            SYNAGOGUE: {name: "Converting Synagogues", year: 1411, location: "Toledo, Spain", playAs: "Saint Vincent Ferrer", tasks: 5, objective: "Preach in Hebrew, convert Jewish scholars"},
            MOSQUE: {name: "Mission to Mosques", year: 1412, location: "Granada, Spain", playAs: "Saint Vincent Ferrer", tasks: 5, objective: "Preach in Arabic, convert Muslims"},
            LAME_WALK: {name: "The Lame Walk", year: 1415, location: "Valencia", playAs: "Saint Vincent Ferrer", tasks: 6, objective: "Heal 6 crippled people"},
            CONSTANCE: {name: "Council of Constance", year: 1416, location: "Constance, Germany", playAs: "Saint Vincent Ferrer", tasks: 4, objective: "Withdraw support from Benedict, seek unity"},
            MARTIN: {name: "Supporting Pope Martin V", year: 1417, location: "Rome", playAs: "Saint Vincent Ferrer", tasks: 3, objective: "Declare for Martin V, end schism"},
            RESURRECTION: {name: "Raising the Dead", year: 1410, location: "Salamanca", playAs: "Saint Vincent Ferrer", tasks: 3, objective: "Command corpses to testify"},
            FRANCE_TOUR: {name: "Tour of France", year: 1418, location: "France", playAs: "Saint Vincent Ferrer", tasks: 7, objective: "Visit 7 major cities preaching"},
            FINAL: {name: "Final Journey", year: 1419, location: "Brittany", playAs: "Saint Vincent Ferrer", tasks: 5, objective: "Complete final mission, prepare for death"},
            DEATH: {name: "The Holy Death", year: 1419, location: "Vannes, Brittany", playAs: "Saint Vincent Ferrer", tasks: 2, objective: "Receive last rites, commend spirit"},
            FUNERAL: {name: "Funeral Miracles", year: 1419, location: "Vannes Cathedral", playAs: "Brother Thomas (Pupil)", tasks: 5, objective: "Witness 5 funeral miracles"},
            INVESTIGATION: {name: "Papal Investigation", year: 1453, location: "Rome", playAs: "Brother Thomas (Pupil)", tasks: 4, objective: "Testify about miracles witnessed"},
            CANONIZATION: {name: "Declaration of Sainthood", year: 1455, location: "Rome, Vatican", playAs: "Brother Thomas (Pupil)", tasks: 3, objective: "Hear Pope's declaration, celebrate"}
        };

        // Game State
        let scene, camera, renderer, gameState = 'title';
        let currentChapter = 'WOMB_BARKING';
        let playerModel, cameraTarget = new THREE.Vector3();
        let tasksCompleted = 0, tasksRequired = 0;
        let canFly = false, soulsConverted = 0, dialogueQueue = [];
        let audioContext, masterGain;
        const keys = {}, interactables = [], buildings = [], doors = [], walls = [];
        let mouseX = 0, mouseY = 0, cameraAngle = 0;
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent);
        let joyActive = false, joyStartX = 0, joyStartY = 0, joyDeltaX = 0, joyDeltaY = 0;
        let isIndoors = false, currentBuilding = null;
        let indoorObjects = {}; // Objects by building ID
        let outdoorObjects = []; // All outdoor objects
        
        // Animation variables
        let walkCycle = 0, isMoving = false;
        let leftArm, rightArm, leftLeg, rightLeg;
        
        // FPS counter
        let fps = 60, lastFrameTime = performance.now(), frameCount = 0;

        // Gregorian Chant
        const GREGORIAN_SCALE = {D3: 146.83, E3: 164.81, F3: 174.61, G3: 196.00, A3: 220.00, B3: 246.94, C4: 261.63, D4: 293.66, E4: 329.63, F4: 349.23, G4: 392.00, A4: 440.00};
        const CHANTS = {KYRIE: [{note:'D4',dur:1.0},{note:'F4',dur:0.5},{note:'G4',dur:0.5},{note:'A4',dur:1.5}]};

        function init() {
            scene = new THREE.Scene();
            
            // Epic sky gradient with realistic colors
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.FogExp2(0x87CEEB, 0.006);

            camera = new THREE.PerspectiveCamera(85, window.innerWidth / window.innerHeight, 0.1, 1000); // Wider FOV (85¬∞) for better building visibility
            camera.position.set(0, 10, 10);
            camera.lookAt(0, 2, 0); // Look slightly higher
            
            renderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                powerPreference: "high-performance",
                stencil: false,
                depth: true,
                alpha: false,
                premultipliedAlpha: true,
                preserveDrawingBuffer: false,
                failIfMajorPerformanceCaveat: false
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Cap at 2 for performance
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.shadowMap.autoUpdate = true;
            renderer.physicallyCorrectLights = true;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.5; // Increased for more vibrant colors
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.gammaFactor = 2.2;
            
            // Performance optimizations
            renderer.info.autoReset = true;
            renderer.sortObjects = true;
            renderer.logarithmicDepthBuffer = false; // Better for performance
            
            document.body.appendChild(renderer.domElement);

            // Enhanced ultra-realistic lighting system
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.2); // Increased for better visibility
            scene.add(ambientLight);
            
            // Main sun light - ultra high quality shadows
            const sunLight = new THREE.DirectionalLight(0xfff5e6, 4.5); // Increased intensity
            sunLight.position.set(100, 200, 100);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 4096; // High resolution shadows (4K for compatibility)
            sunLight.shadow.mapSize.height = 4096;
            sunLight.shadow.camera.left = -200;
            sunLight.shadow.camera.right = 200;
            sunLight.shadow.camera.top = 200;
            sunLight.shadow.camera.bottom = -200;
            sunLight.shadow.camera.near = 0.5;
            sunLight.shadow.camera.far = 500;
            sunLight.shadow.bias = -0.00001; // Reduced shadow acne
            sunLight.shadow.radius = 2; // Soft shadow edges
            sunLight.shadow.normalBias = 0.02;
            scene.add(sunLight);

            // Fill light - blue ambient for realistic sky lighting
            const fillLight = new THREE.DirectionalLight(0x9db4ff, 1.2); // Increased
            fillLight.position.set(-100, 100, -100);
            scene.add(fillLight);
            
            // Back light for rim lighting effect
            const backLight = new THREE.DirectionalLight(0xffeaa7, 0.8);
            backLight.position.set(0, 80, -150);
            scene.add(backLight);
            
            // Hemisphere light for natural sky/ground gradient
            // Hemisphere light for natural sky/ground gradient
            const skyLight = new THREE.HemisphereLight(0x87CEEB, 0x5d8c3e, 1.0); // Increased
            scene.add(skyLight);

            document.getElementById('start-button').addEventListener('click', startGame);
            document.getElementById('dialogue-continue').addEventListener('click', advanceDialogue);
            document.getElementById('interact-button').addEventListener('click', tryInteract);
            document.getElementById('next-chapter-button').addEventListener('click', nextChapter);
            document.getElementById('door-button').addEventListener('click', handleDoorButton);
            document.addEventListener('keydown', e => { 
                keys[e.key.toLowerCase()] = true; 
                if(e.key.toLowerCase() === 'e') tryInteract();
            });
            document.addEventListener('keyup', e => { keys[e.key.toLowerCase()] = false; });
            document.addEventListener('mousemove', onMouseMove);
            window.addEventListener('resize', onResize);

            if(isMobile) setupMobileJoystick();
            initAudio();
            animate();
        }

        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                masterGain = audioContext.createGain();
                masterGain.connect(audioContext.destination);
                masterGain.gain.value = 0.15;
            } catch(e) {}
        }

        function playChant(name = 'KYRIE') {
            if(!audioContext) return;
            const chant = CHANTS[name] || CHANTS.KYRIE;
            let time = audioContext.currentTime;
            chant.forEach(n => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.frequency.value = GREGORIAN_SCALE[n.note];
                gain.gain.setValueAtTime(0, time);
                gain.gain.linearRampToValueAtTime(0.6, time + 0.15);
                gain.gain.linearRampToValueAtTime(0, time + n.dur);
                osc.connect(gain);
                gain.connect(masterGain);
                osc.start(time);
                osc.stop(time + n.dur);
                time += n.dur;
            });
        }

        function setupMobileJoystick() {
            const stick = document.querySelector('.joystick-stick');
            const base = document.querySelector('.joystick-base');
            base.addEventListener('touchstart', e => {
                e.preventDefault();
                joyActive = true;
                const rect = base.getBoundingClientRect();
                joyStartX = rect.left + rect.width/2;
                joyStartY = rect.top + rect.height/2;
            });
            base.addEventListener('touchmove', e => {
                if(!joyActive) return;
                e.preventDefault();
                const touch = e.touches[0];
                const dx = touch.clientX - joyStartX;
                const dy = touch.clientY - joyStartY;
                const dist = Math.min(40, Math.sqrt(dx*dx + dy*dy));
                const angle = Math.atan2(dy, dx);
                joyDeltaX = Math.cos(angle) * (dist/40);
                joyDeltaY = Math.sin(angle) * (dist/40);
                stick.style.transform = `translate(calc(-50% + ${dist*Math.cos(angle)}px), calc(-50% + ${dist*Math.sin(angle)}px))`;
            });
            base.addEventListener('touchend', e => {
                e.preventDefault();
                joyActive = false;
                joyDeltaX = 0; joyDeltaY = 0;
                stick.style.transform = 'translate(-50%, -50%)';
            });
        }

        function handleDoorButton() {
            const nearestDoor = findNearestDoor();
            if(nearestDoor) {
                openDoor(nearestDoor);
            }
        }

        function startGame() {
            try {
                document.getElementById('title-screen').style.display = 'none';
                gameState = 'playing';
                loadChapter('WOMB_BARKING');
                playChant('KYRIE');
            } catch(error) {
                console.error('Error starting game:', error);
                alert('Error starting game. Please refresh the page.');
            }
        }

        function loadChapter(key) {
            try {
                if(!CHAPTERS[key]) {
                    console.error('Chapter not found:', key);
                    return;
                }
                
                currentChapter = key;
                const ch = CHAPTERS[key];
                document.getElementById('current-chapter').textContent = ch.name;
                document.getElementById('current-location').textContent = ch.location;
                document.getElementById('current-year').textContent = ch.year;
                document.getElementById('playing-as').textContent = 'Playing as: ' + ch.playAs;
                document.getElementById('objective-text').textContent = ch.objective;
                tasksRequired = ch.tasks;
                tasksCompleted = 0;
                updateTaskProgress();
                showChapterTitle(ch.name);
                clearScene();
                interactables.length = 0;
                buildings.length = 0;
                doors.length = 0;
                walls.length = 0;
                indoorObjects = {}; // Reset indoor objects
                outdoorObjects = []; // Reset outdoor objects
                isIndoors = false;
                currentBuilding = null;
                document.getElementById('next-chapter-button').style.display = 'none';

                // Create enhanced player model with limbs for animation
                if(ch.playAs.includes('Mother')) {
                    playerModel = createMotherModel();
                } else if(ch.playAs.includes('Young Vincent')) {
                    playerModel = createYoungVincentModel();
                } else if(ch.playAs.includes('Vincent')) {
                    playerModel = createVincentModel();
                } else if(ch.playAs.includes('Thomas')) {
                    playerModel = createPupilModel();
                } else {
                    playerModel = createVincentModel(); // Default
                }
                
                if(!playerModel) {
                    console.error('Failed to create player model');
                    return;
                }
                
                playerModel.position.set(0, 0, 0);
                scene.add(playerModel);

            // Load chapter content
            switch(key) {
                case 'WOMB_BARKING': loadWombBarkingChapter(); break;
                case 'WOMB_HEALING': loadWombHealingChapter(); break;
                case 'BIRTH': loadBirthChapter(); break;
                case 'CHILDHOOD': loadChildhoodChapter(); break;
                case 'EDUCATION': loadEducationChapter(); break;
                case 'DOMINICAN': loadDominicanChapter(); break;
                case 'PROFESSOR': loadProfessorChapter(); break;
                case 'PEDRO_LUNA': loadPedroLunaChapter(); break;
                case 'PLAGUE': loadPlagueChapter(); break;
                case 'VISION': loadVisionChapter(); break;
                case 'FIRST_MISSION': loadFirstMissionChapter(); break;
                case 'ALLEGIANCE': loadAllegianceChapter(); break;
                case 'BISHOPS': loadBishopsChapter(); break;
                case 'PREACHING': loadPreachingChapter(); break;
                case 'TONGUES': loadTonguesChapter(); break;
                case 'CHILD_REVIVAL': loadChildRevivalChapter(); break;
                case 'SEVERED_HEAD': loadSeveredHeadChapter(); break;
                case 'WINGS': loadWingsChapter(); break;
                case 'MULTIPLICATION': loadMultiplicationChapter(); break;
                case 'SYNAGOGUE': loadSynagogueChapter(); break;
                case 'MOSQUE': loadMosqueChapter(); break;
                case 'LAME_WALK': loadLameWalkChapter(); break;
                case 'CONSTANCE': loadConstanceChapter(); break;
                case 'MARTIN': loadMartinChapter(); break;
                case 'RESURRECTION': loadResurrectionChapter(); break;
                case 'FRANCE_TOUR': loadFranceTourChapter(); break;
                case 'FINAL': loadFinalChapter(); break;
                case 'DEATH': loadDeathChapter(); break;
                case 'FUNERAL': loadFuneralChapter(); break;
                case 'INVESTIGATION': loadInvestigationChapter(); break;
                case 'CANONIZATION': loadCanonizationChapter(); break;
            }
            } catch(error) {
                console.error('Error loading chapter:', key, error);
                alert('Error loading chapter. Please refresh the page.');
            }
        }

        function showChapterTitle(title) {
            const el = document.getElementById('chapter-title');
            el.innerHTML = `<div style="font-size: 20px; margin-bottom: 8px; text-shadow: 0 0 20px rgba(212,175,55,0.8);">${title}</div>
                <div style="font-size: 14px; color: #f0e6d2;">Complete all tasks to continue your journey</div>`;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 4500);
        }

        function clearScene() {
            while(scene.children.length > 0) { 
                const obj = scene.children[0];
                if(obj.geometry) obj.geometry.dispose();
                if(obj.material) {
                    if(Array.isArray(obj.material)) obj.material.forEach(m => m.dispose());
                    else obj.material.dispose();
                }
                scene.remove(obj);
            }
            
            // Rebuild ultra-epic lighting system
            const ambient = new THREE.AmbientLight(0xffffff, 1.2);
            scene.add(ambient);
            
            const sun = new THREE.DirectionalLight(0xfff5e6, 4.5);
            sun.position.set(100, 200, 100);
            sun.castShadow = true;
            sun.shadow.mapSize.width = 4096;
            sun.shadow.mapSize.height = 4096;
            sun.shadow.camera.left = -200;
            sun.shadow.camera.right = 200;
            sun.shadow.camera.top = 200;
            sun.shadow.camera.bottom = -200;
            sun.shadow.camera.near = 0.5;
            sun.shadow.camera.far = 500;
            sun.shadow.bias = -0.00001;
            sun.shadow.radius = 2;
            sun.shadow.normalBias = 0.02;
            scene.add(sun);
            
            const fill = new THREE.DirectionalLight(0x9db4ff, 1.2);
            fill.position.set(-100, 100, -100);
            scene.add(fill);
            
            const back = new THREE.DirectionalLight(0xffeaa7, 0.8);
            back.position.set(0, 80, -150);
            scene.add(back);
            
            const sky = new THREE.HemisphereLight(0x87CEEB, 0x5d8c3e, 1.0);
            scene.add(sky);
        }

        function updateTaskProgress() {
            document.getElementById('task-progress').textContent = `${tasksCompleted} / ${tasksRequired} Tasks`;
            if(tasksCompleted >= tasksRequired) {
                document.getElementById('next-chapter-button').style.display = 'block';
                showMiracle('‚ú® CHAPTER COMPLETE! ‚ú®');
                playCompletionSound();
            }
        }

        function playCompletionSound() {
            if(!audioContext) return;
            const notes = [523.25, 659.25, 783.99, 1046.50];
            let time = audioContext.currentTime;
            notes.forEach((freq, i) => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0, time);
                gain.gain.linearRampToValueAtTime(0.3, time + 0.05);
                gain.gain.linearRampToValueAtTime(0, time + 0.3);
                osc.connect(gain);
                gain.connect(masterGain);
                osc.start(time);
                osc.stop(time + 0.3);
                time += 0.15;
            });
        }

        function nextChapter() {
            const chapters = Object.keys(CHAPTERS);
            const currentIdx = chapters.indexOf(currentChapter);
            if(currentIdx < chapters.length - 1) {
                loadChapter(chapters[currentIdx + 1]);
            } else {
                showGameComplete();
            }
        }

        function showGameComplete() {
            document.getElementById('chapter-title').innerHTML = `
                <div style="color:#d4af37; font-size:22px; text-shadow: 0 0 20px rgba(212,175,55,1);">‚úùÔ∏è JOURNEY COMPLETE ‚úùÔ∏è</div>
                <div style="color:#f0e6d2; font-size:12px; margin-top:10px; line-height:1.7;">
                    You have lived the miraculous life of<br>
                    <strong style="color:#d4af37; font-size:14px;">SAINT VINCENT FERRER</strong><br><br>
                    <strong style="color:#4a9eff; font-size:13px;">Total Souls Converted: ${soulsConverted.toLocaleString()}</strong><br><br>
                    "Fear the Lord and give Him glory." - Revelation 14:7<br><br>
                    Saint Vincent Ferrer, pray for us!<br><br>
                    <div style="font-size:10px; margin-top:8px;">Refresh to play again</div>
                </div>
            `;
            document.getElementById('chapter-title').style.display = 'block';
        }

        function showDialogue(dlg) {
            if(!dlg) { 
                document.getElementById('dialogue-box').style.display = 'none'; 
                return; 
            }
            document.getElementById('dialogue-speaker').textContent = dlg.speaker;
            document.getElementById('dialogue-text').textContent = dlg.text;
            document.getElementById('dialogue-box').style.display = 'block';
        }

        function advanceDialogue() {
            dialogueQueue.shift();
            if(dialogueQueue.length > 0) {
                showDialogue(dialogueQueue[0]);
            } else {
                document.getElementById('dialogue-box').style.display = 'none';
            }
        }

        function tryInteract() {
            // E key only handles tasks/interactables, NOT doors
            // Doors are ONLY opened via the door button
            const nearest = findNearestInteractable();
            if(nearest) {
                executeInteraction(nearest);
            }
        }

        function findNearestDoor() {
            if(!playerModel) return null;
            let nearest = null;
            let nearestDist = 10; // Increased from 6 to 10 for very easy detection
            doors.forEach(door => {
                const dist = playerModel.position.distanceTo(door.position);
                if(dist < nearestDist) {
                    nearest = door;
                    nearestDist = dist;
                }
            });
            return nearest;
        }

        function openDoor(door) {
            if(!door) return;
            
            // If door is already open and leads somewhere, handle transition
            if(door.userData.isOpen) {
                if(door.userData.leadsToInterior) {
                    enterBuilding(door.userData.buildingId);
                } else if(door.userData.leadsToExterior) {
                    exitBuilding();
                }
                return;
            }
            
            // Open the door with simple animation
            door.userData.isOpen = true;
            const targetRotation = door.rotation.y + Math.PI/2;
            
            const animateDoor = () => {
                if(door.rotation.y < targetRotation - 0.1) {
                    door.rotation.y += 0.15;
                    requestAnimationFrame(animateDoor);
                } else {
                    door.rotation.y = targetRotation;
                }
            };
            animateDoor();
        }

        function enterBuilding(buildingId) {
            isIndoors = true;
            currentBuilding = buildingId;
            
            // Hide all outdoor objects
            outdoorObjects.forEach(obj => {
                if(obj && obj.visible !== undefined) obj.visible = false;
            });
            
            // Hide outdoor environment and show indoor lights in one pass
            scene.children.forEach(obj => {
                // Handle lights
                if(obj.type === 'PointLight') {
                    if(obj.userData.isIndoor && obj.userData.buildingId === buildingId) {
                        obj.visible = true; // Show lights for this building
                    } else if(!obj.userData.isIndoor) {
                        obj.visible = false; // Hide outdoor lights
                    }
                }
                // Hide outdoor environment objects
                else if(obj.userData && !obj.userData.isIndoor && obj !== playerModel && 
                   obj.type !== 'AmbientLight' && obj.type !== 'DirectionalLight' && 
                   obj.type !== 'HemisphereLight' && obj !== camera) {
                    if(obj.geometry && (obj.geometry.type === 'PlaneGeometry' || 
                       obj.geometry.type === 'BoxGeometry' || 
                       obj.geometry.type === 'CylinderGeometry' ||
                       obj.geometry.type === 'SphereGeometry' ||
                       obj.geometry.type === 'ConeGeometry')) {
                        obj.visible = false;
                    }
                }
            });
            
            // Create interior walls and floor if not exists
            createBuildingInterior(buildingId);
            
            // Show objects that belong in this building
            if(indoorObjects[buildingId]) {
                indoorObjects[buildingId].forEach(obj => {
                    if(obj && obj.visible !== undefined) obj.visible = true;
                });
            }
            
            // Position player inside
            playerModel.position.set(0, 0, 8);
            showMiracle('‚õ™ Entered Building');
        }

        function exitBuilding() {
            isIndoors = false;
            const lastBuilding = currentBuilding;
            currentBuilding = null;
            
            // Hide all indoor objects
            Object.values(indoorObjects).flat().forEach(obj => {
                if(obj && obj.visible !== undefined) obj.visible = false;
            });
            
            // Remove interior walls and handle visibility in one pass
            walls.length = 0;
            const wallsToRemove = [];
            const exitDoorsToRemove = [];
            
            scene.children.forEach(obj => {
                // Collect interior walls for removal
                if(obj.geometry && obj.userData.isInteriorWall) {
                    wallsToRemove.push(obj);
                }
                // Handle lights and visibility
                else if(obj.type === 'PointLight') {
                    if(obj.userData.isIndoor) {
                        obj.visible = false; // Hide indoor lights
                    } else {
                        obj.visible = true; // Show outdoor lights
                    }
                }
                // Show outdoor environment objects
                else if(obj !== playerModel && obj.type !== 'AmbientLight' && 
                       obj.type !== 'DirectionalLight' && obj.type !== 'HemisphereLight' && 
                       obj !== camera) {
                    if(!obj.userData || !obj.userData.isIndoor) {
                        if(obj.geometry) obj.visible = true;
                    }
                }
            });
            
            // Remove interior walls
            wallsToRemove.forEach(obj => {
                if(obj.geometry) obj.geometry.dispose();
                if(obj.material) obj.material.dispose();
                scene.remove(obj);
            });
            
            // Remove interior exit doors
            const exitDoors = doors.filter(d => d.userData.leadsToExterior);
            exitDoors.forEach(d => {
                if(d.geometry) d.geometry.dispose();
                if(d.material) d.material.dispose();
                scene.remove(d);
                const index = doors.indexOf(d);
                if(index > -1) doors.splice(index, 1);
            });
            
            // Show all outdoor objects
            outdoorObjects.forEach(obj => {
                if(obj && obj.visible !== undefined) obj.visible = true;
            });
            
            // Position player outside the building
            if(lastBuilding) {
                const building = buildings.find(b => b.id === lastBuilding);
                if(building) playerModel.position.set(building.x, 0, building.z + 12);
            }
            showMiracle('üåç Exited Building');
        }

        function createBuildingInterior(buildingId) {
            // Check if interior already exists
            const hasInterior = scene.children.some(obj => obj.userData && obj.userData.isInteriorWall);
            if(hasInterior) return; // Already created
            
            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(25, 25),
                new THREE.MeshStandardMaterial({
                    color: 0x8b7355, 
                    roughness: 0.92,
                    metalness: 0
                })
            );
            floor.rotation.x = -Math.PI/2;
            floor.receiveShadow = true;
            floor.userData = { isInteriorWall: true };
            scene.add(floor);
            
            const wallMaterial = new THREE.MeshStandardMaterial({
                color: 0xd4a373, 
                roughness: 0.88,
                metalness: 0
            });
            
            const backWall = new THREE.Mesh(new THREE.BoxGeometry(25, 8, 0.5), wallMaterial);
            backWall.position.set(0, 4, -12);
            backWall.castShadow = true;
            backWall.receiveShadow = true;
            backWall.userData = { isInteriorWall: true };
            scene.add(backWall);
            walls.push({x: 0, z: -12, width: 25, height: 8, depth: 0.5, rotation: 0});
            
            const leftWall = new THREE.Mesh(new THREE.BoxGeometry(0.5, 8, 25), wallMaterial);
            leftWall.position.set(-12, 4, 0);
            leftWall.castShadow = true;
            leftWall.receiveShadow = true;
            leftWall.userData = { isInteriorWall: true };
            scene.add(leftWall);
            walls.push({x: -12, z: 0, width: 0.5, height: 8, depth: 25, rotation: 0});
            
            const rightWall = new THREE.Mesh(new THREE.BoxGeometry(0.5, 8, 25), wallMaterial);
            rightWall.position.set(12, 4, 0);
            rightWall.castShadow = true;
            rightWall.receiveShadow = true;
            rightWall.userData = { isInteriorWall: true };
            scene.add(rightWall);
            walls.push({x: 12, z: 0, width: 0.5, height: 8, depth: 25, rotation: 0});
            
            const frontWallLeft = new THREE.Mesh(new THREE.BoxGeometry(9, 8, 0.5), wallMaterial);
            frontWallLeft.position.set(-7.5, 4, 12);
            frontWallLeft.castShadow = true;
            frontWallLeft.userData = { isInteriorWall: true };
            scene.add(frontWallLeft);
            walls.push({x: -7.5, z: 12, width: 9, height: 8, depth: 0.5, rotation: 0});
            
            const frontWallRight = new THREE.Mesh(new THREE.BoxGeometry(9, 8, 0.5), wallMaterial);
            frontWallRight.position.set(7.5, 4, 12);
            frontWallRight.castShadow = true;
            frontWallRight.userData = { isInteriorWall: true };
            scene.add(frontWallRight);
            walls.push({x: 7.5, z: 12, width: 9, height: 8, depth: 0.5, rotation: 0});
            
            const exitDoor = createDoor(0, 0, 11.5, false, null, true);
            exitDoor.userData.isInteriorWall = true;
            doors.push(exitDoor);
            
            if(buildingId && buildingId.includes('house')) {
                const bed = new THREE.Mesh(
                    new THREE.BoxGeometry(3.5, 0.6, 5),
                    new THREE.MeshStandardMaterial({
                        color: 0x8b4513,
                        roughness: 0.85,
                        metalness: 0.05
                    })
                );
                bed.position.set(-6, 0.6, -6);
                bed.castShadow = true;
                bed.userData = { isInteriorWall: true };
                scene.add(bed);
                
                const table = new THREE.Mesh(
                    new THREE.BoxGeometry(4, 0.3, 2.5),
                    new THREE.MeshStandardMaterial({
                        color: 0x654321,
                        roughness: 0.8,
                        metalness: 0.1
                    })
                );
                table.position.set(6, 1.8, -4);
                table.castShadow = true;
                table.userData = { isInteriorWall: true };
                scene.add(table);
            } else if(buildingId && buildingId.includes('church')) {
                const altar = new THREE.Mesh(
                    new THREE.BoxGeometry(5, 2, 2.5),
                    new THREE.MeshStandardMaterial({
                        color: 0xd4af37,
                        metalness: 0.6,
                        roughness: 0.3
                    })
                );
                altar.position.set(0, 1, -9);
                altar.castShadow = true;
                altar.userData = { isInteriorWall: true };
                scene.add(altar);
                
                const cross = new THREE.Group();
                const crossV = new THREE.Mesh(
                    new THREE.BoxGeometry(0.3, 2.5, 0.3),
                    new THREE.MeshStandardMaterial({
                        color: 0xffd700,
                        emissive: 0xffd700,
                        emissiveIntensity: 0.8,
                        metalness: 0.7
                    })
                );
                crossV.position.y = 1.25;
                cross.add(crossV);
                const crossH = new THREE.Mesh(
                    new THREE.BoxGeometry(1.5, 0.3, 0.3),
                    new THREE.MeshStandardMaterial({
                        color: 0xffd700,
                        emissive: 0xffd700,
                        emissiveIntensity: 0.8,
                        metalness: 0.7
                    })
                );
                crossH.position.y = 0.8;
                cross.add(crossH);
                cross.position.set(0, 2, -9);
                cross.userData = { isInteriorWall: true };
                scene.add(cross);
                
                const crossLight = new THREE.PointLight(0xffd700, 2, 15);
                crossLight.position.set(0, 4, -9);
                crossLight.userData = { isInteriorWall: true };
                scene.add(crossLight);
            }
            
            const interiorLight = new THREE.PointLight(0xffa500, 2.5, 30);
            interiorLight.position.set(0, 7, 0);
            interiorLight.castShadow = true;
            interiorLight.userData = { isInteriorWall: true };
            scene.add(interiorLight);
        }

        function findNearestInteractable() {
            if(!playerModel) return null;
            let nearest = null;
            let nearestDist = 3.5;
            interactables.forEach(obj => {
                // Only find visible interactables (don't find hidden indoor objects when outside)
                if(obj.visible === false) return;
                const dist = playerModel.position.distanceTo(obj.position);
                if(dist < nearestDist) {
                    nearest = obj;
                    nearestDist = dist;
                }
            });
            return nearest;
        }

        function executeInteraction(obj) {
            scene.remove(obj);
            const idx = interactables.indexOf(obj);
            if(idx > -1) interactables.splice(idx, 1);
            
            // Remove associated light to prevent orphaned lights
            if(obj.userData.light) {
                scene.remove(obj.userData.light);
            }
            
            tasksCompleted++;
            updateTaskProgress();
            updateRadar();
            
            if(obj.userData.dialogue) {
                dialogueQueue = obj.userData.dialogue;
                showDialogue(dialogueQueue[0]);
            }
            
            if(obj.userData.effect === 'heal') {
                createMiracleEffect(obj.position.x, obj.position.y + 1, obj.position.z, 0xffffff);
                addConversions(obj.userData.souls || 10);
            } else if(obj.userData.effect === 'preach') {
                createMiracleEffect(obj.position.x, obj.position.y + 1, obj.position.z, 0xffd700);
                addConversions(obj.userData.souls || 50);
            } else if(obj.userData.effect === 'convert') {
                createMiracleEffect(obj.position.x, obj.position.y + 1, obj.position.z, 0x4a9eff);
                addConversions(obj.userData.souls || 25);
            }
        }

        function addConversions(count) {
            soulsConverted += count;
            document.getElementById('souls-converted').textContent = soulsConverted.toLocaleString();
            showMiracle(`+${count} Souls!`);
        }

        function showMiracle(text) {
            const el = document.createElement('div');
            el.className = 'miracle-effect';
            el.textContent = text;
            document.body.appendChild(el);
            setTimeout(() => document.body.removeChild(el), 2500);
        }

        function updateRadar() {
            const radar = document.getElementById('mini-radar');
            const existing = radar.querySelectorAll('.radar-objective');
            existing.forEach(e => e.remove());

            if(!playerModel) return;

            interactables.forEach(obj => {
                // Only show visible interactables on radar (don't show hidden indoor objects)
                if(obj.visible === false) return;
                
                const dx = obj.position.x - playerModel.position.x;
                const dz = obj.position.z - playerModel.position.z;
                const dist = Math.sqrt(dx*dx + dz*dz);
                
                if(dist < 60) {
                    const radarX = (dx / 60) * 75 + 85;
                    const radarY = (dz / 60) * 75 + 85;
                    
                    const dot = document.createElement('div');
                    dot.className = 'radar-objective';
                    dot.style.left = radarX + 'px';
                    dot.style.top = radarY + 'px';
                    radar.appendChild(dot);
                }
            });
        }

        function checkCollision(newX, newZ) {
            // When indoors, check wall collision
            if(isIndoors) {
                for(let wall of walls) {
                    const halfWidth = wall.width / 2;
                    const halfDepth = wall.depth / 2;
                    
                    if(newX > wall.x - halfWidth - COLLISION_DISTANCE && 
                       newX < wall.x + halfWidth + COLLISION_DISTANCE &&
                       newZ > wall.z - halfDepth - COLLISION_DISTANCE && 
                       newZ < wall.z + halfDepth + COLLISION_DISTANCE) {
                        return true;
                    }
                }
                return false;
            }
            
            // When outdoors, buildings are HOLLOW - walk freely around and into them
            // Only block the very center core to prevent walking through
            for(let building of buildings) {
                const dx = newX - building.x;
                const dz = newZ - building.z;
                const dist = Math.sqrt(dx*dx + dz*dz);
                
                // Buildings are hollow - only the tiny center core blocks
                // This allows approaching from any angle, walking around perimeter
                const centerCollisionRadius = Math.min(building.radius * 0.2, 4); // Only 20% of radius or 4 units
                
                if(dist < centerCollisionRadius) {
                    return true; // Only block the very center
                }
            }
            
            return false; // Allow all other movement
        }

        // ENHANCED PLAYER MODELS WITH ANIMATED LIMBS

        function createMotherModel() {
            const group = new THREE.Group();
            const dress = new THREE.Mesh(
                new THREE.CylinderGeometry(0.45, 0.55, 1.5, 20),
                new THREE.MeshStandardMaterial({
                    color: 0x8b4789,
                    roughness: 0.65,
                    metalness: 0.15
                })
            );
            dress.position.y = 0.75;
            dress.castShadow = true;
            dress.receiveShadow = true;
            group.add(dress);
            
            const head = new THREE.Mesh(
                new THREE.SphereGeometry(0.28, 20, 20),
                new THREE.MeshStandardMaterial({
                    color: 0xf0c291,
                    roughness: 0.45
                })
            );
            head.position.y = 1.75;
            head.castShadow = true;
            group.add(head);
            
            // Animated arms
            const armGeo = new THREE.CylinderGeometry(0.09, 0.09, 0.8, 10);
            const armMat = new THREE.MeshStandardMaterial({
                color: 0xf0c291,
                roughness: 0.5
            });
            leftArm = new THREE.Mesh(armGeo, armMat);
            leftArm.position.set(-0.5, 0.9, 0);
            leftArm.rotation.z = 0.5;
            leftArm.castShadow = true;
            group.add(leftArm);
            
            rightArm = new THREE.Mesh(armGeo, armMat);
            rightArm.position.set(0.5, 0.9, 0);
            rightArm.rotation.z = -0.5;
            rightArm.castShadow = true;
            group.add(rightArm);
            
            group.userData.limbs = {leftArm, rightArm};
            return group;
        }

        function createYoungVincentModel() {
            const group = new THREE.Group();
            const body = new THREE.Mesh(
                new THREE.CylinderGeometry(0.28, 0.32, 1.1, 16),
                new THREE.MeshStandardMaterial({
                    color: 0x4a4a4a,
                    roughness: 0.75
                })
            );
            body.position.y = 0.55;
            body.castShadow = true;
            group.add(body);
            
            const head = new THREE.Mesh(
                new THREE.SphereGeometry(0.22, 18, 18),
                new THREE.MeshStandardMaterial({
                    color: 0xf0c291,
                    roughness: 0.45
                })
            );
            head.position.y = 1.3;
            head.castShadow = true;
            group.add(head);
            
            // Animated limbs
            const armGeo = new THREE.CylinderGeometry(0.07, 0.07, 0.6, 10);
            const armMat = new THREE.MeshStandardMaterial({color: 0xf0c291, roughness: 0.5});
            leftArm = new THREE.Mesh(armGeo, armMat);
            leftArm.position.set(-0.38, 0.7, 0);
            leftArm.rotation.z = 0.4;
            leftArm.castShadow = true;
            group.add(leftArm);
            
            rightArm = new THREE.Mesh(armGeo, armMat);
            rightArm.position.set(0.38, 0.7, 0);
            rightArm.rotation.z = -0.4;
            rightArm.castShadow = true;
            group.add(rightArm);
            
            const legGeo = new THREE.CylinderGeometry(0.09, 0.08, 0.55, 10);
            const legMat = new THREE.MeshStandardMaterial({color: 0x2c3e50, roughness: 0.75});
            leftLeg = new THREE.Mesh(legGeo, legMat);
            leftLeg.position.set(-0.13, 0.18, 0);
            leftLeg.castShadow = true;
            group.add(leftLeg);
            
            rightLeg = new THREE.Mesh(legGeo, legMat);
            rightLeg.position.set(0.13, 0.18, 0);
            rightLeg.castShadow = true;
            group.add(rightLeg);
            
            group.userData.limbs = {leftArm, rightArm, leftLeg, rightLeg};
            return group;
        }

        function createVincentModel() {
            const group = new THREE.Group();
            const habit = new THREE.Mesh(
                new THREE.CylinderGeometry(0.38, 0.44, 1.5, 20),
                new THREE.MeshStandardMaterial({
                    color: 0x000000,
                    roughness: 0.88
                })
            );
            habit.position.y = 0.75;
            habit.castShadow = true;
            group.add(habit);
            
            const scapular = new THREE.Mesh(
                new THREE.BoxGeometry(0.65, 1.3, 0.06),
                new THREE.MeshStandardMaterial({
                    color: 0xffffff,
                    roughness: 0.65
                })
            );
            scapular.position.set(0, 0.75, 0.24);
            scapular.castShadow = true;
            group.add(scapular);
            
            const head = new THREE.Mesh(
                new THREE.SphereGeometry(0.27, 20, 20),
                new THREE.MeshStandardMaterial({
                    color: 0xf0c291,
                    roughness: 0.45
                })
            );
            head.position.y = 1.7;
            head.castShadow = true;
            group.add(head);
            
            const halo = new THREE.Mesh(
                new THREE.TorusGeometry(0.38, 0.05, 20, 40),
                new THREE.MeshStandardMaterial({
                    color: 0xffd700,
                    emissive: 0xffd700,
                    emissiveIntensity: 1.2,
                    metalness: 0.8,
                    roughness: 0.2
                })
            );
            halo.position.y = 2.1;
            halo.rotation.x = Math.PI/2;
            group.add(halo);
            
            // Add glow to halo
            const haloLight = new THREE.PointLight(0xffd700, 0.8, 4);
            haloLight.position.y = 2.1;
            group.add(haloLight);
            
            // Animated limbs
            const armGeo = new THREE.CylinderGeometry(0.09, 0.09, 0.8, 10);
            const armMat = new THREE.MeshStandardMaterial({color: 0xf0c291, roughness: 0.5});
            leftArm = new THREE.Mesh(armGeo, armMat);
            leftArm.position.set(-0.5, 0.9, 0);
            leftArm.rotation.z = 0.4;
            leftArm.castShadow = true;
            group.add(leftArm);
            
            rightArm = new THREE.Mesh(armGeo, armMat);
            rightArm.position.set(0.5, 0.9, 0);
            rightArm.rotation.z = -0.4;
            rightArm.castShadow = true;
            group.add(rightArm);
            
            const legGeo = new THREE.CylinderGeometry(0.1, 0.09, 0.55, 10);
            const legMat = new THREE.MeshStandardMaterial({color: 0x000000, roughness: 0.88});
            leftLeg = new THREE.Mesh(legGeo, legMat);
            leftLeg.position.set(-0.16, 0.18, 0);
            leftLeg.castShadow = true;
            group.add(leftLeg);
            
            rightLeg = new THREE.Mesh(legGeo, legMat);
            rightLeg.position.set(0.16, 0.18, 0);
            rightLeg.castShadow = true;
            group.add(rightLeg);
            
            group.userData.limbs = {leftArm, rightArm, leftLeg, rightLeg};
            return group;
        }

        function createPupilModel() {
            const group = new THREE.Group();
            const robe = new THREE.Mesh(
                new THREE.CylinderGeometry(0.38, 0.44, 1.5, 20),
                new THREE.MeshStandardMaterial({
                    color: 0x8b4513,
                    roughness: 0.88
                })
            );
            robe.position.y = 0.75;
            robe.castShadow = true;
            group.add(robe);
            
            const head = new THREE.Mesh(
                new THREE.SphereGeometry(0.27, 20, 20),
                new THREE.MeshStandardMaterial({
                    color: 0xf0c291,
                    roughness: 0.45
                })
            );
            head.position.y = 1.7;
            head.castShadow = true;
            group.add(head);
            
            // Animated limbs
            const armGeo = new THREE.CylinderGeometry(0.09, 0.09, 0.8, 10);
            const armMat = new THREE.MeshStandardMaterial({color: 0xf0c291, roughness: 0.5});
            leftArm = new THREE.Mesh(armGeo, armMat);
            leftArm.position.set(-0.5, 0.9, 0);
            leftArm.rotation.z = 0.4;
            leftArm.castShadow = true;
            group.add(leftArm);
            
            rightArm = new THREE.Mesh(armGeo, armMat);
            rightArm.position.set(0.5, 0.9, 0);
            rightArm.rotation.z = -0.4;
            rightArm.castShadow = true;
            group.add(rightArm);
            
            const legGeo = new THREE.CylinderGeometry(0.1, 0.09, 0.55, 10);
            const legMat = new THREE.MeshStandardMaterial({color: 0x654321, roughness: 0.88});
            leftLeg = new THREE.Mesh(legGeo, legMat);
            leftLeg.position.set(-0.16, 0.18, 0);
            leftLeg.castShadow = true;
            group.add(leftLeg);
            
            rightLeg = new THREE.Mesh(legGeo, legMat);
            rightLeg.position.set(0.16, 0.18, 0);
            rightLeg.castShadow = true;
            group.add(rightLeg);
            
            group.userData.limbs = {leftArm, rightArm, leftLeg, rightLeg};
            return group;
        }

        // ENVIRONMENT CREATORS WITH PHOTOREALISTIC MATERIALS

        function createGround() {
            const ground = new THREE.Mesh(
                new THREE.PlaneGeometry(250, 250, 50, 50), // Reduced from 80
                new THREE.MeshStandardMaterial({
                    color: 0x5d8c3e,
                    roughness: 0.95,
                    metalness: 0
                })
            );
            ground.rotation.x = -Math.PI/2;
            ground.receiveShadow = true;
            scene.add(ground);
        }

        function createNPC(x, y, z, color = 0x4a4a4a, isIndoor = false, buildingId = null) {
            const group = new THREE.Group();
            const body = new THREE.Mesh(
                new THREE.CylinderGeometry(0.32, 0.37, 1.3, 16), // Reduced from 24
                new THREE.MeshStandardMaterial({
                    color: color,
                    roughness: 0.8,
                    metalness: 0.15
                })
            );
            body.position.y = 0.65;
            body.castShadow = true;
            body.receiveShadow = true;
            group.add(body);
            
            const head = new THREE.Mesh(
                new THREE.SphereGeometry(0.26, 16, 16), // Reduced from 24
                new THREE.MeshStandardMaterial({
                    color: 0xf0c291,
                    roughness: 0.45,
                    metalness: 0.05
                })
            );
            head.position.y = 1.5;
            head.castShadow = true;
            head.receiveShadow = true;
            group.add(head);
            
            // Ultra-realistic arms
            const armGeo = new THREE.CylinderGeometry(0.09, 0.09, 0.7, 8);
            const armMat = new THREE.MeshStandardMaterial({
                color: 0xf0c291, 
                roughness: 0.5,
                metalness: 0.05
            });
            const leftArmNPC = new THREE.Mesh(armGeo, armMat);
            leftArmNPC.position.set(-0.44, 0.8, 0);
            leftArmNPC.rotation.z = 0.4;
            leftArmNPC.castShadow = true;
            leftArmNPC.receiveShadow = true;
            group.add(leftArmNPC);
            const rightArmNPC = new THREE.Mesh(armGeo, armMat);
            rightArmNPC.position.set(0.44, 0.8, 0);
            rightArmNPC.rotation.z = -0.4;
            rightArmNPC.castShadow = true;
            rightArmNPC.receiveShadow = true;
            group.add(rightArmNPC);
            
            // Ultra-realistic legs
            const legGeo = new THREE.CylinderGeometry(0.11, 0.1, 0.55, 8);
            const legMat = new THREE.MeshStandardMaterial({
                color: 0x2c3e50, 
                roughness: 0.8,
                metalness: 0.1
            });
            const leftLegNPC = new THREE.Mesh(legGeo, legMat);
            leftLegNPC.position.set(-0.16, 0.18, 0);
            leftLegNPC.castShadow = true;
            leftLegNPC.receiveShadow = true;
            group.add(leftLegNPC);
            const rightLegNPC = new THREE.Mesh(legGeo, legMat);
            rightLegNPC.position.set(0.16, 0.18, 0);
            rightLegNPC.castShadow = true;
            rightLegNPC.receiveShadow = true;
            group.add(rightLegNPC);
            
            group.position.set(x, y, z);
            group.userData = { isIndoor: isIndoor, buildingId: buildingId };
            
            // Track indoor vs outdoor
            if(isIndoor && buildingId) {
                if(!indoorObjects[buildingId]) indoorObjects[buildingId] = [];
                indoorObjects[buildingId].push(group);
                group.visible = false; // Hide until entering building
            } else {
                outdoorObjects.push(group);
            }
            
            scene.add(group);
            return group;
        }

        function createHouse(x, y, z, id = 'house') {
            const wall = new THREE.Mesh(
                new THREE.BoxGeometry(14, 7, 14),
                new THREE.MeshStandardMaterial({
                    color: 0xd4a373,
                    roughness: 0.88,
                    metalness: 0.05
                })
            );
            wall.position.set(x, y + 3.5, z);
            wall.castShadow = true;
            wall.receiveShadow = true;
            scene.add(wall);
            
            const roof = new THREE.Mesh(
                new THREE.ConeGeometry(10.5, 4.5, 4),
                new THREE.MeshStandardMaterial({
                    color: 0x8b4513,
                    roughness: 0.93
                })
            );
            roof.position.set(x, y + 9, z);
            roof.rotation.y = Math.PI/4;
            roof.castShadow = true;
            roof.receiveShadow = true;
            scene.add(roof);
            
            const door = createDoor(x, y, z + 7, true, id);
            doors.push(door);
            
            const doorFrame = new THREE.Mesh(
                new THREE.BoxGeometry(2.7, 5, 0.35),
                new THREE.MeshStandardMaterial({
                    color: 0x654321,
                    roughness: 0.85
                })
            );
            doorFrame.position.set(x, y + 2.5, z + 7.3);
            doorFrame.castShadow = true;
            doorFrame.receiveShadow = true;
            scene.add(doorFrame);
            
            buildings.push({x: x, z: z, radius: 5, id: id});
        }

        function createChurch(x, y, z, id = 'church') {
            const main = new THREE.Mesh(
                new THREE.BoxGeometry(28, 17, 38),
                new THREE.MeshStandardMaterial({
                    color: 0xa89968,
                    roughness: 0.88,
                    metalness: 0.05
                })
            );
            main.position.set(x, y + 8.5, z);
            main.castShadow = true;
            main.receiveShadow = true;
            scene.add(main);
            
            const tower = new THREE.Mesh(
                new THREE.BoxGeometry(6, 28, 6),
                new THREE.MeshStandardMaterial({
                    color: 0x8b7355,
                    roughness: 0.88
                })
            );
            tower.position.set(x - 13, y + 14, z + 13);
            tower.castShadow = true;
            tower.receiveShadow = true;
            scene.add(tower);
            
            const cross = new THREE.Group();
            const crossV = new THREE.Mesh(
                new THREE.BoxGeometry(0.5, 3.5, 0.5),
                new THREE.MeshStandardMaterial({
                    color: 0xffd700,
                    emissive: 0xffd700,
                    emissiveIntensity: 1.0,
                    metalness: 0.8,
                    roughness: 0.2
                })
            );
            crossV.position.y = 1.75;
            crossV.castShadow = true;
            cross.add(crossV);
            const crossH = new THREE.Mesh(
                new THREE.BoxGeometry(2.2, 0.5, 0.5),
                new THREE.MeshStandardMaterial({
                    color: 0xffd700,
                    emissive: 0xffd700,
                    emissiveIntensity: 1.0,
                    metalness: 0.8,
                    roughness: 0.2
                })
            );
            crossH.position.y = 1.2;
            crossH.castShadow = true;
            cross.add(crossH);
            cross.position.set(x - 13, y + 29, z + 13);
            scene.add(cross);
            
            // Glowing cross light (no shadows for performance)
            const crossLight = new THREE.PointLight(0xffd700, 2.0, 25);
            crossLight.position.set(x - 13, y + 30, z + 13);
            scene.add(crossLight);
            
            const door = createDoor(x, y, z + 19, true, id);
            door.scale.set(1.6, 1.3, 1);
            doors.push(door); // Ensure door is added to array
            
            const doorFrame = new THREE.Mesh(
                new THREE.BoxGeometry(4.5, 7, 0.35),
                new THREE.MeshStandardMaterial({
                    color: 0x654321,
                    roughness: 0.88,
                    metalness: 0.05
                })
            );
            doorFrame.position.set(x, y + 3.5, z + 19.3);
            doorFrame.castShadow = true;
            doorFrame.receiveShadow = true;
            scene.add(doorFrame);
            
            // Reduced collision radius from 16 to 10 so players can reach the door
            buildings.push({x: x, z: z + 19, radius: 10, id: id});
        }

        function createDoor(x, y, z, leadsToInterior = false, buildingId = null, leadsToExterior = false) {
            const door = new THREE.Mesh(
                new THREE.BoxGeometry(2.2, 4.5, 0.25),
                new THREE.MeshStandardMaterial({
                    color: 0x4a2511,
                    roughness: 0.85,
                    metalness: 0.1
                })
            );
            door.position.set(x, y + 2.25, z);
            door.castShadow = true;
            door.receiveShadow = true;
            
            const handle = new THREE.Mesh(
                new THREE.SphereGeometry(0.12, 12, 12),
                new THREE.MeshStandardMaterial({
                    color: 0xffd700,
                    metalness: 0.9,
                    roughness: 0.15,
                    emissive: 0xffd700,
                    emissiveIntensity: 0.4
                })
            );
            handle.position.set(x + 0.8, y + 2.25, z + 0.18);
            handle.castShadow = true;
            handle.receiveShadow = true;
            scene.add(handle);
            
            // Glowing light to make door visible (no shadows for performance)
            const doorLight = new THREE.PointLight(0xffd700, 1.5, 15);
            doorLight.position.set(x, y + 2.5, z + 0.5);
            scene.add(doorLight);
            
            // Add glowing beacon above door for maximum visibility
            const beacon = new THREE.Mesh(
                new THREE.SphereGeometry(0.3, 16, 16),
                new THREE.MeshStandardMaterial({
                    color: 0xffd700,
                    emissive: 0xffd700,
                    emissiveIntensity: 2.0,
                    metalness: 0.8,
                    roughness: 0.2
                })
            );
            beacon.position.set(x, y + 6, z + 0.5);
            beacon.userData.isDoorBeacon = true;
            beacon.userData.baseY = y + 6;
            scene.add(beacon);
            
            door.userData = {
                isOpen: false,
                openAngle: Math.PI/2,
                leadsToInterior: leadsToInterior,
                leadsToExterior: leadsToExterior,
                buildingId: buildingId,
                isDoor: true,
                light: doorLight,
                beacon: beacon
            };
            
            scene.add(door);
            return door;
        }

        function createTree(x, y, z) {
            const trunk = new THREE.Mesh(
                new THREE.CylinderGeometry(0.35, 0.45, 5, 12), // Reduced from 16
                new THREE.MeshStandardMaterial({
                    color: 0x6B4423,
                    roughness: 0.98,
                    metalness: 0
                })
            );
            trunk.position.set(x, y + 2.5, z);
            trunk.castShadow = true;
            trunk.receiveShadow = true;
            scene.add(trunk);
            
            const leaves = new THREE.Mesh(
                new THREE.SphereGeometry(3, 16, 16), // Reduced from 24
                new THREE.MeshStandardMaterial({
                    color: 0x2d5016,
                    roughness: 0.85,
                    metalness: 0
                })
            );
            leaves.position.set(x, y + 6.5, z);
            leaves.castShadow = true;
            leaves.receiveShadow = true;
            scene.add(leaves);
        }

        function createBush(x, y, z) {
            const bush = new THREE.Mesh(
                new THREE.SphereGeometry(0.9, 12, 12), // Reduced from 16
                new THREE.MeshStandardMaterial({
                    color: 0x228B22,
                    roughness: 0.9,
                    metalness: 0
                })
            );
            bush.scale.set(1, 0.65, 1);
            bush.position.set(x, y + 0.35, z);
            bush.castShadow = true;
            bush.receiveShadow = true;
            scene.add(bush);
        }

        function createInteractable(x, y, z, type, label, dialogue = [], effect = null, souls = 0, isIndoor = false, buildingId = null) {
            const obj = new THREE.Mesh(
                new THREE.BoxGeometry(0.7, 0.7, 0.7),
                new THREE.MeshStandardMaterial({
                    color: 0xffd700,
                    emissive: 0xffd700,
                    emissiveIntensity: 1.2,
                    metalness: 0.6,
                    roughness: 0.3
                })
            );
            obj.position.set(x, y, z);
            obj.userData = {
                type: type,
                label: label,
                dialogue: dialogue,
                effect: effect,
                souls: souls,
                floatOffset: Math.random() * Math.PI * 2,
                isIndoor: isIndoor,
                buildingId: buildingId
            };
            obj.castShadow = true;
            obj.receiveShadow = true;
            
            // Track indoor vs outdoor
            if(isIndoor && buildingId) {
                if(!indoorObjects[buildingId]) indoorObjects[buildingId] = [];
                indoorObjects[buildingId].push(obj);
                obj.visible = false; // Hide until entering building
            } else {
                outdoorObjects.push(obj);
            }
            
            scene.add(obj);
            interactables.push(obj);
            
            // Simple glowing light around objectives (no shadows to improve performance)
            const light = new THREE.PointLight(0xffd700, 1.5, 8);
            light.position.copy(obj.position);
            light.userData = { isIndoor: isIndoor, buildingId: buildingId };
            if(isIndoor) light.visible = false;
            scene.add(light);
            
            // Store light reference so it can be removed when interactable is collected
            obj.userData.light = light;
            
            return obj;
        }

        function createMiracleEffect(x, y, z, color) {
            const particles = new THREE.Group();
            for(let i = 0; i < 50; i++) {
                const particle = new THREE.Mesh(
                    new THREE.SphereGeometry(0.14, 8, 8),
                    new THREE.MeshBasicMaterial({
                        color: color,
                        transparent: true,
                        opacity: 0.95
                    })
                );
                particle.position.set(
                    x + (Math.random() - 0.5) * 4,
                    y + (Math.random() - 0.5) * 4,
                    z + (Math.random() - 0.5) * 4
                );
                particles.add(particle);
            }
            scene.add(particles);
            
            let rot = 0;
            const animate = () => {
                rot += 0.04;
                particles.rotation.y = rot;
                particles.children.forEach((p, i) => {
                    p.position.y += Math.sin(rot + i * 0.6) * 0.025;
                    p.rotation.x += 0.02;
                    p.rotation.y += 0.03;
                });
                if(rot < 7) requestAnimationFrame(animate);
                else scene.remove(particles);
            };
            animate();
        }

        // CHAPTER LOADERS
        function loadWombBarkingChapter() {
            createGround();
            createHouse(0, 0, -12, 'womb-house-1');
            for(let i = 0; i < 8; i++) createTree(-30 + i * 10, 0, -35);
            for(let i = 0; i < 15; i++) createBush(-20 + Math.random() * 40, 0, -25 + Math.random() * 15);

            // Husband character (OUTDOOR)
            createNPC(6, 0, 4, 0x4a2511, false, null);
            createInteractable(6, 1, 4, 'talk', 'Talk to William', [
                {speaker: "William (Husband)", text: "Constance, do you hear that sound? It's coming from your womb!"},
                {speaker: "You (Constance)", text: "Yes! The child barks like a dog! He will be a hound of the Lord!"}
            ], null, 0, false, null);

            // Neighbor witnessing (OUTDOOR)
            createNPC(-6, 0, 6, 0x8b4513, false, null);
            createInteractable(-6, 1, 6, 'talk', 'Talk to Neighbor', [
                {speaker: "Neighbor", text: "We heard the barking from outside! This is a miracle from God!"}
            ], null, 0, false, null);
            
            // Priest to bless (OUTDOOR)
            createNPC(-10, 0, -5, 0x000000, false, null);
            createInteractable(-10, 1, -5, 'talk', 'Receive Blessing from Priest', [
                {speaker: "Priest", text: "God has marked this child for greatness. Let us pray for His holy purpose."},
                {speaker: "You (Constance)", text: "Father, pray for me and my unborn child."}
            ], 'heal', 5, false, null);
            
            // INDOOR example - Mother inside house (can be visited)
            createNPC(0, 0, -5, 0x8b4789, true, 'womb-house-1');
            createInteractable(0, 1, -5, 'talk', 'Talk to Mother (Inside House)', [
                {speaker: "Mother", text: "Rest, my daughter. The Lord is working a great miracle within you."}
            ], null, 0, true, 'womb-house-1');
            
            updateRadar();
        }

        function loadWombHealingChapter() {
            createGround();
            createHouse(0, 0, -12, 'womb-house-2');
            for(let i = 0; i < 8; i++) createTree(-30 + i * 10, 0, -35);

            // Blind woman
            createNPC(-7, 0, 5, 0x2c3e50);
            createInteractable(-7, 1, 5, 'heal', 'Touch blind woman', [
                {speaker: "Blind Woman", text: "Please, may I touch your womb? I have been blind for years!"},
                {speaker: "You (Constance)", text: "Yes, sister. May God's will be done."},
                {speaker: "Blind Woman", text: "I CAN SEE! Your child healed me! This baby is blessed by God!"}
            ], 'heal', 1);
            
            // Sick neighbor
            createNPC(7, 0, 5, 0x4a4a4a);
            createInteractable(7, 1, 5, 'heal', 'Heal sick neighbor', [
                {speaker: "Sick Neighbor", text: "I have been ill with fever. May the child in your womb heal me too?"},
                {speaker: "You (Constance)", text: "Through God's grace, may you be healed."},
                {speaker: "Sick Neighbor", text: "The fever is gone! The child is truly blessed!"}
            ], 'heal', 1);
            
            updateRadar();
        }

        function loadBirthChapter() {
            createGround();
            createHouse(0, 0, -12, 'birth-house');
            for(let i = 0; i < 10; i++) createTree(-40 + i * 10, 0, -40);

            // Midwife
            createNPC(4, 0, -6, 0xffffff);
            createInteractable(4, 1, -6, 'birth', 'Begin Labor', [
                {speaker: "Midwife", text: "It is time, Constance. Let us bring this blessed child into the world."},
                {speaker: "You (Constance)", text: "Holy Mary, Mother of God, pray for me!"}
            ], 'heal', 0);
            
            // Witness the holy light
            createInteractable(0, 1, -8, 'witness', 'Witness the Holy Light', [
                {speaker: "Midwife", text: "The child is born! And such a holy light surrounds him!"},
                {speaker: "Narrator", text: "January 23, 1350 - Vincent Ferrer is born with miraculous signs."}
            ], 'heal', 0);
            
            updateRadar();
        }

        function loadChildhoodChapter() {
            createGround();
            createHouse(12, 0, -18, 'childhood-house');
            createChurch(-18, 0, -28, 'childhood-church');
            for(let i = 0; i < 12; i++) createTree(-35 + i * 6, 0, -45);

            // Pray at church
            createInteractable(-14, 0.5, -22, 'pray', 'Pray at Church', [
                {speaker: "Young Vincent", text: "Lord, I dedicate my life to You. I will serve You always."}
            ]);

            // Study the Bible
            createInteractable(-10, 0.5, -24, 'study', 'Study the Bible', [
                {speaker: "Young Vincent", text: "The Word of God is my daily bread. I must know Scripture deeply."}
            ], 'preach', 5);

            // Help poor woman
            createNPC(-8, 0, 5, 0x654321);
            createInteractable(-8, 1, 5, 'help', 'Help Poor Woman', [
                {speaker: "Poor Woman", text: "Young Vincent, my family has no food."},
                {speaker: "Young Vincent", text: "Take this, and know that God provides."}
            ], 'heal', 2);

            // Talk to father
            createNPC(10, 0, -12, 0x4a2511);
            createInteractable(10, 1, -12, 'talk', 'Talk to Father', [
                {speaker: "Father", text: "Vincent, I see the calling of God upon you. You will do great things."}
            ]);
            
            updateRadar();
        }

        function loadEducationChapter() {
            createGround();
            // University building with proper door
            const university = new THREE.Mesh(
                new THREE.BoxGeometry(35, 20, 30),
                new THREE.MeshStandardMaterial({color: 0xa89968, roughness: 0.85, metalness: 0.05})
            );
            university.position.set(0, 10, -25);
            university.castShadow = true;
            university.receiveShadow = true;
            scene.add(university);
            
            // Add door to university
            const universityDoor = createDoor(0, 0, -10, true, 'university');
            doors.push(universityDoor);
            
            // Door frame
            const doorFrame = new THREE.Mesh(
                new THREE.BoxGeometry(3, 6, 0.5),
                new THREE.MeshStandardMaterial({color: 0x654321, roughness: 0.85})
            );
            doorFrame.position.set(0, 3, -9.7);
            doorFrame.castShadow = true;
            scene.add(doorFrame);
            
            buildings.push({x: 0, z: -25, radius: 18, id: 'university'});

            for(let i = 0; i < 15; i++) createTree(-50 + i * 8, 0, -50);
            
            // OUTDOOR: Classmate outside who tells you about lectures inside
            createNPC(8, 0, 5, 0x2c3e50, false, null);
            createInteractable(8, 1, 5, 'talk', 'Talk to Student Outside', [
                {speaker: "Student", text: "The philosophy lectures are inside the university. Enter to attend!"}
            ], null, 0, false, null);
            
            // INDOOR: Attend philosophy lecture (INSIDE UNIVERSITY)
            createNPC(-6, 0, -5, 0x654321, true, 'university');
            createInteractable(-6, 1, -5, 'study', 'Attend Philosophy Lecture', [
                {speaker: "Professor", text: "Today we study the works of Thomas Aquinas on divine providence."},
                {speaker: "Young Vincent", text: "I must master both faith and reason to serve God well."}
            ], 'preach', 10, true, 'university');

            // INDOOR: Help struggling classmate (INSIDE)
            createNPC(6, 0, -6, 0x2c3e50, true, 'university');
            createInteractable(6, 1, -6, 'help', 'Tutor Classmate', [
                {speaker: "Classmate", text: "Vincent, I don't understand Aristotle's logic."},
                {speaker: "Young Vincent", text: "Let me explain. Truth proceeds from God..."}
            ], 'preach', 5, true, 'university');

            // INDOOR: Study in library (INSIDE)
            createInteractable(0, 0.5, -8, 'study', 'Study Ancient Texts', [
                {speaker: "Young Vincent", text: "The wisdom of the Church Fathers illuminates Scripture."}
            ], 'preach', 10, true, 'university');

            // INDOOR: Debate theology (INSIDE)
            createNPC(-8, 0, -3, 0x8b4513, true, 'university');
            createInteractable(-8, 1, -3, 'debate', 'Theological Debate', [
                {speaker: "Student", text: "Let us debate the nature of divine grace!"},
                {speaker: "Young Vincent", text: "Through reason and revelation, we seek truth."}
            ], 'preach', 15, true, 'university');

            // INDOOR: Write thesis (INSIDE)
            createInteractable(4, 0.5, -7, 'write', 'Write Philosophical Thesis', [
                {speaker: "Young Vincent", text: "I must commit my understanding to writing for future scholars."}
            ], 'preach', 20, true, 'university');
            
            updateRadar();
        }

        function loadProfessorChapter() {
            createGround();
            createChurch(0, 0, -22, 'cathedral-valencia');
            for(let i = 0; i < 15; i++) createTree(-40 + i * 6, 0, -45);

            // Teach morning class
            for(let i = 0; i < 8; i++) createNPC(-10 + i * 3, 0, -15, 0x2c3e50);
            createInteractable(0, 0.5, -10, 'teach', 'Teach Philosophy Class', [
                {speaker: "Vincent", text: "Students, today we examine the relationship between faith and reason."},
                {speaker: "Students", text: "Professor Vincent's wisdom is renowned throughout the kingdom!"}
            ], 'preach', 50);

            // Write theological treatise
            createInteractable(-15, 0.5, -8, 'write', 'Write Treatise on Divine Providence', [
                {speaker: "Vincent", text: "I must defend the faith with both Scripture and philosophy."}
            ], 'preach', 30);

            // Debate visiting scholar
            createNPC(15, 0, -8, 0x4a2511);
            createInteractable(15, 1, -8, 'debate', 'Debate Visiting Scholar', [
                {speaker: "Scholar", text: "Let us debate the problem of evil, Professor Vincent."},
                {speaker: "Vincent", text: "Through Aquinas, we see that God permits evil for greater good."}
            ], 'preach', 40);

            // Counsel troubled student
            createNPC(-18, 0, 5, 0x654321);
            createInteractable(-18, 1, 5, 'counsel', 'Counsel Student', [
                {speaker: "Student", text: "Professor, I struggle with doubts about my faith."},
                {speaker: "Vincent", text: "My child, doubt is the beginning of understanding. Let us pray together."}
            ], 'heal', 10);
            
            updateRadar();
        }

        function loadPedroLunaChapter() {
            createGround();
            // Papal palace with proper door
            const palace = new THREE.Mesh(
                new THREE.BoxGeometry(50, 25, 40),
                new THREE.MeshStandardMaterial({color: 0xf5deb3, roughness: 0.75, metalness: 0.05})
            );
            palace.position.set(0, 12.5, -35);
            palace.castShadow = true;
            palace.receiveShadow = true;
            scene.add(palace);
            
            // Add door to palace
            const palaceDoor = createDoor(0, 0, -15, true, 'papal-palace');
            doors.push(palaceDoor);
            
            // Door frame
            const doorFrame = new THREE.Mesh(
                new THREE.BoxGeometry(3.5, 7, 0.5),
                new THREE.MeshStandardMaterial({color: 0xffd700, roughness: 0.4, metalness: 0.7})
            );
            doorFrame.position.set(0, 3.5, -14.7);
            doorFrame.castShadow = true;
            scene.add(doorFrame);
            
            buildings.push({x: 0, z: -35, radius: 25, id: 'papal-palace'});

            for(let i = 0; i < 10; i++) createTree(-40 + i * 10, 0, -55);

            // INDOOR: Meet Cardinal Pedro de Luna (INSIDE PALACE)
            createNPC(-5, 0, -5, 0x8b0000, true, 'papal-palace');
            createInteractable(-5, 1, -5, 'talk', 'Meet Cardinal Pedro', [
                {speaker: "Cardinal Pedro de Luna", text: "Father Vincent, I need a wise confessor. Will you guide my soul?"},
                {speaker: "Vincent", text: "I will serve as God wills, Your Eminence."}
            ], null, 0, true, 'papal-palace');

            // INDOOR: Hear confession (INSIDE)
            createInteractable(5, 0.5, -6, 'confess', 'Hear Cardinal\'s Confession', [
                {speaker: "Cardinal Pedro", text: "Bless me, Father, for I have sinned..."},
                {speaker: "Vincent", text: "Through God's mercy, you are absolved. Go and sin no more."}
            ], 'heal', 5, true, 'papal-palace');

            // INDOOR: Pray for guidance (INSIDE)
            createInteractable(0, 0.5, -8, 'pray', 'Pray for Papal Wisdom', [
                {speaker: "Vincent", text: "Lord, guide me to counsel this prince of Your Church wisely."}
            ], null, 0, true, 'papal-palace');
            
            updateRadar();
        }

        function loadFirstMissionChapter() {
            createGround();
            for(let i = 0; i < 20; i++) createTree(-60 + i * 7, 0, -50);

            const towns = [
                {name: "Aix", x: -20, z: -15, souls: 150},
                {name: "Marseille", x: -10, z: -20, souls: 200},
                {name: "Toulouse", x: 5, z: -18, souls: 180},
                {name: "Bordeaux", x: 15, z: -15, souls: 220},
                {name: "Lyon", x: 20, z: -22, souls: 250},
                {name: "Avignon", x: 0, z: -25, souls: 300}
            ];

            towns.forEach((town, i) => {
                for(let j = 0; j < 5; j++) {
                    createNPC(town.x + (Math.random() - 0.5) * 8, 0, town.z + (Math.random() - 0.5) * 6, 0x2c3e50);
                }
                createInteractable(town.x, 0.5, town.z, 'preach', `Preach in ${town.name}`, [
                    {speaker: "Vincent", text: `People of ${town.name}! Repent and turn to Christ!`},
                    {speaker: "Crowd", text: "We will follow the Lord! Save us, holy father!"}
                ], 'preach', town.souls);
            });
            
            updateRadar();
        }

        function loadDominicanChapter() {
            createGround();
            createChurch(0, 0, -22, 'dominican-church');
            for(let i = 0; i < 15; i++) createTree(-40 + i * 6, 0, -45);

            for(let i = 0; i < 5; i++) createNPC(-9 + i * 4.5, 0, -17, 0x000000);

            // Take vows
            createInteractable(0, 0.5, -17, 'vows', 'Take Dominican Vows', [
                {speaker: "Vincent Ferrer", text: "I vow poverty, chastity, and obedience. I will preach the Gospel of Christ!"},
                {speaker: "Prior", text: "Welcome to the Order of Preachers, Brother Vincent."}
            ]);

            // Receive habit
            createInteractable(-5, 0.5, -15, 'receive', 'Receive Dominican Habit', [
                {speaker: "Prior", text: "Wear this white and black habit as a soldier of Christ."},
                {speaker: "Vincent", text: "I will wear it with honor until my death."}
            ]);

            // Meet brother Dominicans
            createInteractable(5, 0.5, -15, 'meet', 'Meet Fellow Friars', [
                {speaker: "Dominican Brothers", text: "Welcome, Brother Vincent! We will pray and preach together."},
                {speaker: "Vincent", text: "Together we will bring souls to Christ!"}
            ], 'preach', 10);
            
            updateRadar();
        }

        function loadAllegianceChapter() {
            createGround();
            createChurch(0, 0, -25, 'allegiance-church');
            for(let i = 0; i < 12; i++) createTree(-35 + i * 7, 0, -45);

            // Pope Benedict XIII
            createNPC(0, 0, -20, 0xff0000);
            
            // Declare allegiance publicly
            createInteractable(0, 0.5, -15, 'declare', 'Public Declaration', [
                {speaker: "Vincent", text: "I declare Benedict XIII is the true pope! I stake my eternal soul on this truth!"},
                {speaker: "Pope Benedict XIII", text: "Go forth, Vincent. Preach and bring souls to the true Church."}
            ], 'preach', 50);

            // Convince doubting cardinal
            createNPC(-10, 0, -18, 0x8b0000);
            createInteractable(-10, 1, -18, 'convince', 'Convince Cardinal', [
                {speaker: "Doubting Cardinal", text: "How can we know Benedict is legitimate?"},
                {speaker: "Vincent", text: "The Lord Himself has shown me! I will prove it with miracles!"}
            ], 'preach', 25);

            // Gather supporters
            createNPC(10, 0, -18, 0x9b59b6);
            createInteractable(10, 1, -18, 'gather', 'Gather Support', [
                {speaker: "Bishop", text: "If you stake your soul on Benedict's legitimacy, we will follow!"},
                {speaker: "Vincent", text: "Watch and see God's confirmation through signs and wonders!"}
            ], 'preach', 30);
            
            updateRadar();
        }

        function loadTonguesChapter() {
            createGround();
            for(let i = 0; i < 20; i++) createTree(-50 + i * 6, 0, -45);

            // Create crowds speaking different languages
            const languages = [
                {lang: "Breton", x: -18, z: -15, color: 0x4a4a4a},
                {lang: "French", x: -9, z: -18, color: 0x2c3e50},
                {lang: "German", x: 0, z: -20, color: 0x654321},
                {lang: "Italian", x: 9, z: -18, color: 0x8b4513}
            ];

            languages.forEach(lang => {
                for(let i = 0; i < 6; i++) {
                    createNPC(lang.x + (Math.random() - 0.5) * 5, 0, lang.z + (Math.random() - 0.5) * 4, lang.color);
                }
                createInteractable(lang.x, 0.5, lang.z, 'preach', `Preach in ${lang.lang}`, [
                    {speaker: "Vincent", text: "I speak no " + lang.lang + ", yet God allows me to preach!"},
                    {speaker: lang.lang + " Speakers", text: "We understand him perfectly! It is a miracle! He speaks our tongue!"}
                ], 'preach', 100);
            });
            
            updateRadar();
        }

        function loadSeveredHeadChapter() {
            createGround();
            for(let i = 0; i < 25; i++) createTree(-55 + i * 5, 0, -45);
            
            // Crowd gathered
            for(let i = 0; i < 20; i++) {
                createNPC(-15 + Math.random() * 30, 0, -15 + Math.random() * 10, 0x2c3e50);
            }

            // The severed head
            createInteractable(-5, 0.5, -10, 'examine', 'Examine the Severed Head', [
                {speaker: "Man", text: "Father Vincent, this is the head of a criminal. Can you make it speak?"},
                {speaker: "Vincent", text: "Through Christ's power, all things are possible."}
            ]);

            // Command the head to speak
            createInteractable(0, 0.5, -12, 'command', 'Command Head to Speak', [
                {speaker: "Vincent", text: "In the name of Jesus Christ, I command you to speak! Are you saved or damned?"},
                {speaker: "Severed Head", text: "By God's mercy... I am saved... I repented before death..."}
            ], 'heal', 100);

            // Witness testimony
            createInteractable(5, 0.5, -10, 'witness', 'Record the Miracle', [
                {speaker: "Witness", text: "The head spoke! I saw it with my own eyes! This is God's power!"},
                {speaker: "Crowd", text: "Saint Vincent works miracles! God be praised!"}
            ], 'preach', 50);
            
            updateRadar();
        }

        function loadMultiplicationChapter() {
            createGround();
            for(let i = 0; i < 15; i++) createTree(-45 + i * 7, 0, -40);

            const villages = [
                {name: "Village of Hunger", x: -20, z: -15},
                {name: "Starving Hamlet", x: -10, z: -20},
                {name: "Poor Township", x: 0, z: -18},
                {name: "Destitute Village", x: 10, z: -22},
                {name: "Famine-Struck Town", x: 20, z: -17}
            ];

            villages.forEach((village, i) => {
                // Starving families
                for(let j = 0; j < 4; j++) {
                    createNPC(village.x + (Math.random() - 0.5) * 6, 0, village.z + (Math.random() - 0.5) * 4, 0x654321);
                }
                
                createInteractable(village.x, 0.5, village.z, 'multiply', `Feed ${village.name}`, [
                    {speaker: "Starving Mother", text: "Father Vincent, we have no food! Our children are dying!"},
                    {speaker: "Vincent", text: "Bring me what little you have. God will multiply it."},
                    {speaker: "Mother", text: "Just a small loaf of bread, Father..."},
                    {speaker: "Vincent", text: "In Jesus' name, let this bread multiply to feed all!"},
                    {speaker: "Villagers", text: "The bread multiplies in our hands! We are fed! Miracle!"}
                ], 'heal', 80);
            });
            
            updateRadar();
        }

        function loadLameWalkChapter() {
            createGround();
            createChurch(-15, 0, -25, 'lame-church');
            for(let i = 0; i < 18; i++) createTree(-50 + i * 6, 0, -45);

            // Six crippled people
            const cripples = [
                {name: "20 Years Crippled", x: -15, z: -10, years: 20},
                {name: "Born Unable to Walk", x: -8, z: -12, years: 30},
                {name: "Accident Victim", x: 0, z: -14, years: 10},
                {name: "War Wounded", x: 8, z: -12, years: 15},
                {name: "Disease Crippled", x: 15, z: -10, years: 25},
                {name: "Elderly Paralyzed", x: 22, z: -8, years: 35}
            ];

            cripples.forEach((person, i) => {
                createNPC(person.x, 0, person.z, 0x8b4513);
                createInteractable(person.x, 1, person.z, 'heal', `Heal ${person.name}`, [
                    {speaker: person.name, text: `Father Vincent, I haven't walked in ${person.years} years!`},
                    {speaker: "Vincent", text: "In the name of Jesus Christ, STAND UP and WALK!"},
                    {speaker: person.name, text: "I... I can walk! I can run! Praise God! I am healed!"}
                ], 'heal', 75);
            });
            
            updateRadar();
        }

        function loadConstanceChapter() {
            createGround();
            // Council hall with proper door
            const hall = new THREE.Mesh(
                new THREE.BoxGeometry(55, 22, 45),
                new THREE.MeshStandardMaterial({color: 0xa89968, roughness: 0.8, metalness: 0.05})
            );
            hall.position.set(0, 11, -30);
            hall.castShadow = true;
            hall.receiveShadow = true;
            scene.add(hall);
            
            // Add door to council hall
            const hallDoor = createDoor(0, 0, -7.5, true, 'council-hall');
            doors.push(hallDoor);
            
            // Door frame
            const doorFrame = new THREE.Mesh(
                new THREE.BoxGeometry(4, 7, 0.5),
                new THREE.MeshStandardMaterial({color: 0x654321, roughness: 0.85})
            );
            doorFrame.position.set(0, 3.5, -7.2);
            doorFrame.castShadow = true;
            scene.add(doorFrame);
            
            buildings.push({x: 0, z: -30, radius: 27, id: 'council-hall'});

            for(let i = 0; i < 20; i++) createTree(-60 + i * 7, 0, -55);

            // INDOOR: Pray for guidance (INSIDE HALL)
            createInteractable(-10, 0.5, -8, 'pray', 'Pray for Church Unity', [
                {speaker: "Vincent", text: "Lord, show me the path to heal Your Church. I have supported Benedict for 17 years..."}
            ], null, 0, true, 'council-hall');

            // INDOOR: Meet with cardinals (INSIDE)
            for(let i = 0; i < 8; i++) createNPC(-14 + i * 4, 0, -5, 0x8b0000, true, 'council-hall');
            createInteractable(0, 0.5, -3, 'meet', 'Meet Cardinals', [
                {speaker: "Cardinals", text: "Vincent, Benedict refuses all reform. What should we do?"},
                {speaker: "Vincent", text: "For the good of the Church, we must seek unity, even if it means pain."}
            ], 'preach', 50, true, 'council-hall');

            // INDOOR: Make difficult decision (INSIDE)
            createInteractable(10, 0.5, -7, 'decide', 'Withdraw Support from Benedict', [
                {speaker: "Vincent", text: "I followed Pedro de Luna in good faith. But he refuses reform. I must withdraw my support."},
                {speaker: "Narrator", text: "After 17 years of loyalty, Vincent makes the hardest decision of his life."}
            ], 'preach', 100, true, 'council-hall');

            // INDOOR: Announce publicly (INSIDE)
            createInteractable(0, 0.5, -9, 'announce', 'Public Announcement', [
                {speaker: "Vincent", text: "For the unity of Christ's Church, I can no longer support Benedict XIII."},
                {speaker: "Crowd", text: "If Vincent withdraws support, Benedict's cause is lost!"}
            ], 'preach', 150, true, 'council-hall');
            
            updateRadar();
        }

        function loadMartinChapter() {
            createGround();
            // St. Peter's inspired building with proper door
            const basilica = new THREE.Mesh(
                new THREE.BoxGeometry(60, 30, 50),
                new THREE.MeshStandardMaterial({color: 0xf5f5dc, roughness: 0.7, metalness: 0.05})
            );
            basilica.position.set(0, 15, -35);
            basilica.castShadow = true;
            basilica.receiveShadow = true;
            scene.add(basilica);
            
            // Add door to basilica
            const basilicaDoor = createDoor(0, 0, -10, true, 'st-peters');
            basilicaDoor.scale.set(1.4, 1.4, 1);
            doors.push(basilicaDoor);
            
            // Grand door frame
            const doorFrame = new THREE.Mesh(
                new THREE.BoxGeometry(5, 9, 0.5),
                new THREE.MeshStandardMaterial({color: 0xffd700, roughness: 0.3, metalness: 0.8})
            );
            doorFrame.position.set(0, 4.5, -9.7);
            doorFrame.castShadow = true;
            scene.add(doorFrame);
            
            buildings.push({x: 0, z: -35, radius: 30, id: 'st-peters'});

            // INDOOR: Pope Martin V (INSIDE BASILICA)
            createNPC(0, 0, -8, 0xff0000, true, 'st-peters');

            // INDOOR: Declare for Martin (INSIDE)
            createInteractable(0, 0.5, -6, 'declare', 'Declare for Pope Martin V', [
                {speaker: "Vincent", text: "Martin V is the true Vicar of Christ! Let all Christians unite under his authority!"},
                {speaker: "Pope Martin V", text: "Brother Vincent, your support legitimizes my papacy. The schism ends today."}
            ], 'preach', 200, true, 'st-peters');

            // INDOOR: Preach Church unity (INSIDE)
            createInteractable(-10, 0.5, -7, 'preach', 'Preach Church Unity', [
                {speaker: "Vincent", text: "After 39 years, the Western Schism is over! One Church, one Pope, one Faith!"}
            ], 'preach', 300, true, 'st-peters');

            // INDOOR: Celebrate with cardinals (INSIDE)
            for(let i = 0; i < 10; i++) createNPC(-18 + i * 4, 0, -3, 0x8b0000, true, 'st-peters');
            createInteractable(0, 0.5, -2, 'celebrate', 'Celebrate Church Unity', [
                {speaker: "Cardinals", text: "Vincent, you helped end the greatest crisis in Church history!"},
                {speaker: "Vincent", text: "All glory to God who guides His Church through storms."}
            ], 'preach', 250, true, 'st-peters');
            
            updateRadar();
        }

        function loadFranceTourChapter() {
            createGround();
            for(let i = 0; i < 25; i++) createTree(-70 + i * 6, 0, -50);

            const cities = [
                {name: "Paris", x: -25, z: -15, souls: 500},
                {name: "Rouen", x: -15, z: -20, souls: 400},
                {name: "Reims", x: -5, z: -18, souls: 450},
                {name: "Orl√©ans", x: 5, z: -22, souls: 420},
                {name: "Tours", x: 15, z: -17, souls: 380},
                {name: "Nantes", x: 22, z: -20, souls: 460},
                {name: "Rennes", x: 28, z: -15, souls: 440}
            ];

            cities.forEach(city => {
                for(let i = 0; i < 10; i++) {
                    createNPC(city.x + (Math.random() - 0.5) * 8, 0, city.z + (Math.random() - 0.5) * 6, 0x2c3e50);
                }
                createInteractable(city.x, 0.5, city.z, 'preach', `Preach in ${city.name}`, [
                    {speaker: "Vincent", text: `People of ${city.name}! Repent before the Day of Judgment!`},
                    {speaker: "Crowd", text: "Father Vincent's words pierce our hearts! We will repent!"}
                ], 'preach', city.souls);
            });
            
            updateRadar();
        }

        function loadFinalChapter() {
            createGround();
            createChurch(0, 0, -25, 'final-church');
            for(let i = 0; i < 20; i++) createTree(-55 + i * 6, 0, -45);

            // Final sermon
            for(let i = 0; i < 30; i++) {
                createNPC(-20 + Math.random() * 40, 0, -15 + Math.random() * 15, 0x2c3e50);
            }
            createInteractable(0, 0.5, -15, 'preach', 'Give Final Sermon', [
                {speaker: "Vincent", text: "My time on earth nears its end. Fear God and give Him glory, for the hour of judgment has come!"},
                {speaker: "Crowd", text: "Don't leave us, Father Vincent! Who will preach to us?"}
            ], 'preach', 1000);

            // Bless the sick
            createNPC(-12, 0, -8, 0x654321);
            createInteractable(-12, 1, -8, 'heal', 'Heal Final Sick Person', [
                {speaker: "Sick Man", text: "Father, one last healing before you go..."},
                {speaker: "Vincent", text: "Be healed in Christ's name. Remember His mercy."}
            ], 'heal', 50);

            // Counsel young preacher
            createNPC(12, 0, -8, 0x000000);
            createInteractable(12, 1, -8, 'counsel', 'Counsel Young Dominican', [
                {speaker: "Young Friar", text: "Master Vincent, how can I preach as you do?"},
                {speaker: "Vincent", text: "Preach Christ crucified. Let the Holy Spirit do the rest."}
            ], 'preach', 30);

            // Visit the poor
            createNPC(-18, 0, 5, 0x8b4513);
            createInteractable(-18, 1, 5, 'visit', 'Visit Poor Family', [
                {speaker: "Poor Woman", text: "You never forgot us poor ones, Father Vincent."},
                {speaker: "Vincent", text: "Christ is found among the poor. Serve them always."}
            ], 'heal', 20);

            // Pray final prayer
            createInteractable(0, 0.5, -20, 'pray', 'Pray Final Public Prayer', [
                {speaker: "Vincent", text: "Lord Jesus, my work is done. I come to You soon. Amen."}
            ]);
            
            updateRadar();
        }

        function loadInvestigationChapter() {
            createGround();
            // Vatican investigation hall with proper door
            const hall = new THREE.Mesh(
                new THREE.BoxGeometry(50, 25, 40),
                new THREE.MeshStandardMaterial({color: 0xd4af37, roughness: 0.65, metalness: 0.3})
            );
            hall.position.set(0, 12.5, -30);
            hall.castShadow = true;
            hall.receiveShadow = true;
            scene.add(hall);
            
            // Add door to investigation hall
            const hallDoor = createDoor(0, 0, -10, true, 'investigation-hall');
            doors.push(hallDoor);
            
            // Golden door frame
            const doorFrame = new THREE.Mesh(
                new THREE.BoxGeometry(3.5, 7, 0.5),
                new THREE.MeshStandardMaterial({color: 0xffd700, roughness: 0.4, metalness: 0.8})
            );
            doorFrame.position.set(0, 3.5, -9.7);
            doorFrame.castShadow = true;
            scene.add(doorFrame);
            
            buildings.push({x: 0, z: -30, radius: 25, id: 'investigation-hall'});

            // INDOOR: Cardinals investigating (INSIDE HALL)
            for(let i = 0; i < 6; i++) createNPC(-10 + i * 4, 0, -7, 0x8b0000, true, 'investigation-hall');

            // INDOOR: Testify about miracles (INSIDE)
            createInteractable(-7, 0.5, -5, 'testify', 'Testify About Miracles', [
                {speaker: "You (Brother Thomas)", text: "I witnessed Master Vincent raise the dead with my own eyes!"},
                {speaker: "Cardinals", text: "Tell us everything you saw, Brother Thomas."}
            ], 'preach', 50, true, 'investigation-hall');

            // INDOOR: Present written accounts (INSIDE)
            createInteractable(0, 0.5, -7, 'present', 'Present Documentation', [
                {speaker: "You (Brother Thomas)", text: "Here are 873 confirmed miracles, documented by witnesses."},
                {speaker: "Cardinals", text: "This is unprecedented! The evidence is overwhelming!"}
            ], 'preach', 100, true, 'investigation-hall');

            // INDOOR: Recount resurrection miracle (INSIDE)
            createInteractable(7, 0.5, -5, 'recount', 'Recount Dead Raised', [
                {speaker: "You (Brother Thomas)", text: "I saw him command a corpse to speak, and it testified of salvation!"},
                {speaker: "Cardinals", text: "Truly, God worked through this man!"}
            ], 'preach', 80, true, 'investigation-hall');

            // INDOOR: Final testimony (INSIDE)
            createInteractable(0, 0.5, -3, 'final', 'Give Final Testimony', [
                {speaker: "You (Brother Thomas)", text: "Vincent Ferrer was the holiest man I ever knew. He deserves to be named Saint!"},
                {speaker: "Cardinals", text: "We will recommend canonization to His Holiness the Pope!"}
            ], 'preach', 150, true, 'investigation-hall');
            
            updateRadar();
        }

        function loadBishopsChapter() {
            createGround();
            createChurch(-20, 0, -30, 'bishops-church');
            for(let i = 0; i < 15; i++) createTree(-50 + i * 7, 0, -50);
            
            // Bishops
            for(let i = 0; i < 10; i++) {
                createNPC(-18 + i * 4, 0, -20, 0x9b59b6);
            }
            
            // Explain your mission
            createInteractable(-15, 0.5, -18, 'explain', 'Explain Divine Mission', [
                {speaker: "Bishop", text: "How do we know Benedict is legitimate?"},
                {speaker: "Vincent", text: "The Lord Himself showed me in vision! I will prove it with miracles!"}
            ], 'preach', 20);

            // Heal blind man
            createNPC(-8, 0, -15, 0x654321);
            createInteractable(-8, 1, -15, 'heal', 'Heal Blind Man', [
                {speaker: "Blind Man", text: "I have been blind since birth!"},
                {speaker: "Vincent", text: "In Christ's name, see!"},
                {speaker: "Blind Man", text: "I see! Light! Colors! Praise God!"}
            ], 'heal', 30);

            // Heal deaf woman
            createNPC(0, 0, -18, 0x8b4513);
            createInteractable(0, 1, -18, 'heal', 'Heal Deaf Woman', [
                {speaker: "Woman's Daughter", text: "My mother cannot hear!"},
                {speaker: "Vincent", text: "Be opened!"},
                {speaker: "Deaf Woman", text: "I hear! I hear your voices!"}
            ], 'heal', 30);

            // Raise crippled child
            createNPC(8, 0, -15, 0x2c3e50);
            createInteractable(8, 1, -15, 'heal', 'Make Cripple Walk', [
                {speaker: "Father", text: "My son has never walked!"},
                {speaker: "Vincent", text: "Child, in Jesus' name, stand and walk!"},
                {speaker: "Crippled Child", text: "Father! I'm walking! I can run!"}
            ], 'heal', 40);

            // Bishops accept
            createInteractable(0, 0.5, -22, 'convince', 'Convince the Bishops', [
                {speaker: "Bishop", text: "We have seen three miracles! God confirms your mission!"},
                {speaker: "All Bishops", text: "We accept Benedict XIII as the true pope! We will follow!"}
            ], 'preach', 200);
            
            updateRadar();
        }

        function loadPreachingChapter() {
            createGround();
            createChurch(0, 0, -28, 'preaching-church');
            for(let i = 0; i < 25; i++) createTree(-70 + i * 6, 0, -55);

            for(let i = 0; i < 45; i++) {
                createNPC(-25 + Math.random() * 50, 0, -18 + Math.random() * 30, 0x2c3e50);
            }

            for(let i = 0; i < 8; i++) {
                createInteractable(-21 + i * 6, 0.5, -12 + i * 2.5, 'preach', `Preach to Group ${i + 1}`, [
                    {speaker: "Vincent Ferrer", text: "Repent! The day of judgment draws near! Turn to Christ and be saved!"},
                    {speaker: "Crowd", text: "We believe! We will follow Christ! Save our souls, holy father!"}
                ], 'preach', 250);
            }
            
            updateRadar();
        }

        function loadSynagogueChapter() {
            createGround();
            for(let i = 0; i < 25; i++) createNPC(-12 + Math.random() * 24, 0, -22 + Math.random() * 12, 0x000080);

            for(let i = 0; i < 5; i++) {
                createInteractable(-16 + i * 8, 0.5, -18 + i * 4, 'preach', `Preach in Hebrew to Group ${i + 1}`, [
                    {speaker: "Vincent (in Hebrew)", text: "Your Scriptures point to Jesus the Messiah! Isaiah 53 speaks of Him!"},
                    {speaker: "Jewish Scholars", text: "This Christian speaks Hebrew like a rabbi! He knows Torah perfectly!"},
                    {speaker: "Jews", text: "If he speaks the truth, we must listen! Teach us about Yeshua!"}
                ], 'convert', 5000);
            }
            
            updateRadar();
        }

        function loadMosqueChapter() {
            createGround();
            for(let i = 0; i < 30; i++) createNPC(-18 + Math.random() * 36, 0, -22 + Math.random() * 12, 0x006400);

            for(let i = 0; i < 5; i++) {
                createInteractable(-16 + i * 8, 0.5, -18 + i * 4, 'preach', `Preach in Arabic to Group ${i + 1}`, [
                    {speaker: "Vincent (in Arabic)", text: "Isa - Jesus - is the Way, the Truth, and the Life! Come to Him!"},
                    {speaker: "Muslim Scholars", text: "How does this Christian speak pure Arabic? He never studied our language!"},
                    {speaker: "Muslims", text: "This is a sign from Allah! We will hear his message about Isa!"}
                ], 'convert', 1600);
            }
            
            updateRadar();
        }

        function loadChildRevivalChapter() {
            createGround();
            createHouse(12, 0, -18, 'revival-house');
            for(let i = 0; i < 10; i++) createTree(-35 + i * 9, 0, -40);

            const children = [
                {name: "First Child", x: -12, z: 8, mother: "Maria"},
                {name: "Second Child", x: -4, z: 6, mother: "Isabella"},
                {name: "Third Child", x: 4, z: 8, mother: "Teresa"},
                {name: "Fourth Child", x: 12, z: 6, mother: "Ana"}
            ];

            children.forEach((child, i) => {
                createNPC(child.x, 0, child.z, 0x000000);
                createInteractable(child.x, 0.5, child.z, 'heal', `Raise ${child.name}`, [
                    {speaker: child.mother, text: "Father Vincent, my baby is dead! Please, work your miracle!"},
                    {speaker: "Vincent", text: "In the name of Jesus Christ, CHILD, ARISE AND LIVE!"},
                    {speaker: child.mother, text: "The baby breathes! Opens eyes! Alive! MIRACLE! Thank you, holy father!"}
                ], 'heal', 125);
            });
            
            updateRadar();
        }

        function loadPlagueChapter() {
            createGround();
            createHouse(-15, 0, -18, 'plague-house-1');
            createHouse(15, 0, -18, 'plague-house-2');
            createChurch(0, 0, -30, 'plague-church');
            for(let i = 0; i < 12; i++) createTree(-40 + i * 8, 0, -45);

            // Minister to dying plague victims
            createNPC(-18, 0, -10, 0x654321);
            createInteractable(-18, 1, -10, 'minister', 'Minister to Dying Man', [
                {speaker: "Dying Man", text: "*coughing blood* Father... pray for my soul..."},
                {speaker: "Vincent", text: "Through God's mercy, your sins are forgiven. Rest in peace."}
            ], 'heal', 5);

            createNPC(-8, 0, -12, 0x8b4513);
            createInteractable(-8, 1, -12, 'minister', 'Comfort Dying Woman', [
                {speaker: "Woman", text: "I'm so afraid... will God forgive me?"},
                {speaker: "Vincent", text: "Jesus died for your sins. He awaits you with open arms."}
            ], 'heal', 5);

            // Give last rites to fellow priest
            createNPC(8, 0, -14, 0x000000);
            createInteractable(8, 1, -14, 'rites', 'Give Last Rites to Priest', [
                {speaker: "Dying Priest", text: "Brother Vincent... I'm joining our brothers in heaven..."},
                {speaker: "Vincent", text: "Go to the Lord. We will meet again in glory."}
            ], 'heal', 10);

            // Vincent contracts plague
            createInteractable(0, 0.5, -20, 'sick', 'Fall Ill with Plague', [
                {speaker: "Vincent", text: "*burning with fever* Lord... if this is my time... I am ready..."},
                {speaker: "Narrator", text: "Vincent collapsed, near death from the Black Plague."}
            ]);
            
            updateRadar();
        }

        function loadVisionChapter() {
            createGround();
            // Heavenly realm - brighter colors
            scene.background = new THREE.Color(0xffd700);
            scene.fog = new THREE.FogExp2(0xffffff, 0.005);

            // Celestial ground
            const heaven = new THREE.Mesh(
                new THREE.PlaneGeometry(200, 200),
                new THREE.MeshStandardMaterial({
                    color: 0xffffff,
                    roughness: 0.3,
                    metalness: 0.5,
                    emissive: 0xffd700,
                    emissiveIntensity: 0.3
                })
            );
            heaven.rotation.x = -Math.PI/2;
            heaven.receiveShadow = true;
            scene.add(heaven);

            // Christ appears
            createInteractable(0, 2, -15, 'receive', 'Receive Mission from Christ', [
                {speaker: "Jesus Christ", text: "Vincent, your time has not come. I am sending you back."},
                {speaker: "Vincent", text: "Lord! I am unworthy to look upon Your face!"},
                {speaker: "Christ", text: "Go and preach repentance. The world nears the time of Antichrist."},
                {speaker: "Vincent", text: "But Lord, I am weak... I fear..."},
                {speaker: "Christ", text: "My grace is sufficient. I will be with you always."}
            ], 'heal', 100);

            // St. Dominic appears
            createInteractable(-10, 2, -18, 'receive', 'Meet St. Dominic', [
                {speaker: "St. Dominic", text: "Brother Vincent, preach with power! Defend the faith I established!"},
                {speaker: "Vincent", text: "Holy Father Dominic! Pray for me that I may preach as you did!"}
            ], 'preach', 50);

            // St. Francis appears
            createInteractable(10, 2, -18, 'receive', 'Meet St. Francis', [
                {speaker: "St. Francis", text: "Vincent, remember the poor. Serve Christ in the least of His brothers."},
                {speaker: "Vincent", text: "Holy Francis! I will never forget the poor and suffering!"}
            ], 'preach', 50);

            // God the Father speaks
            createInteractable(0, 3, -22, 'receive', 'Hear God the Father', [
                {speaker: "God the Father", text: "YOU ARE MY CHOSEN INSTRUMENT. GO FORTH WITH MY AUTHORITY."},
                {speaker: "Vincent", text: "I will obey, Almighty Father! Send me where You will!"}
            ], 'heal', 200);

            // Return to life
            createInteractable(0, 0.5, -10, 'return', 'Return to Life', [
                {speaker: "Narrator", text: "Vincent's body stirred. His eyes opened. The impossible had happened."},
                {speaker: "Doctor", text: "He lives! This man was dead! Now he breathes! MIRACLE!"}
            ], 'heal', 300);
            
            updateRadar();
        }

        function loadWingsChapter() {
            createGround();
            for(let i = 0; i < 30; i++) createNPC(-15 + Math.random() * 30, 0, -15 + Math.random() * 20, 0x2c3e50);

            // Preach to harbor crowd
            createInteractable(-10, 0.5, -18, 'preach', 'Preach at Harbor', [
                {speaker: "Vincent", text: "Repent and turn to Christ! Judgment approaches!"},
                {speaker: "Crowd", text: "The holy father preaches with such power!"}
            ], 'preach', 200);

            // Crisis moment - man drowning
            createInteractable(0, 0.5, -22, 'crisis', 'See Drowning Man', [
                {speaker: "Witness", text: "HELP! A man fell into the harbor! He cannot swim!"},
                {speaker: "Vincent", text: "Lord, give me wings to save him!"}
            ]);

            // Receive angelic wings and fly
            createInteractable(0, 2, -20, 'fly', 'Fly to Save Drowning Man', [
                {speaker: "Vincent", text: "In Jesus' name, let me fly!"},
                {speaker: "Narrator", text: "Suddenly, brilliant angel wings sprouted from Vincent's back!"},
                {speaker: "Crowd", text: "He flies! He flies like an angel! The saint saves the drowning man!"},
                {speaker: "Saved Man", text: "You flew through the air and pulled me out! You're an angel!"}
            ], 'heal', 500);
            
            updateRadar();
        }

        function loadResurrectionChapter() {
            createGround();
            for(let i = 0; i < 18; i++) createNPC(-12 + Math.random() * 24, 0, -18 + Math.random() * 12, 0x2c3e50);

            // Priest doubts Vincent
            createNPC(-15, 0, -15, 0x000000);
            createInteractable(-15, 1, -15, 'debate', 'Debate Doubting Priest', [
                {speaker: "Priest", text: "You claim Benedict is the true pope. Prove it!"},
                {speaker: "Vincent", text: "I will prove it with a miracle beyond doubt!"}
            ], 'preach', 30);

            // Approach the tomb
            createInteractable(-8, 0.5, -18, 'approach', 'Approach the Tomb', [
                {speaker: "Vincent", text: "Bring me to the newly buried corpse."},
                {speaker: "Gravedigger", text: "Here, Father. He was buried this morning."}
            ]);

            // Command corpse to testify
            createInteractable(0, 0.5, -17, 'resurrect', 'Command Corpse to Speak', [
                {speaker: "Vincent", text: "In Christ's name, whoever you are in this tomb, ARISE! Declare if you are saved or damned!"},
                {speaker: "Dead Man", text: "*groans* I... I am saved... by God's mercy... I repented... before death..."},
                {speaker: "Crowd", text: "THE DEAD SPOKE! We heard it! This proves Vincent speaks for God!"},
                {speaker: "Doubting Priest", text: "I believe! Benedict XIII is the true pope! Forgive my doubt!"}
            ], 'heal', 300);
            
            updateRadar();
        }

        function loadDeathChapter() {
            createGround();
            createHouse(0, 0, -12, 'death-house');
            for(let i = 0; i < 6; i++) createNPC(-7.5 + i * 3, 0, 5, 0x000000); // Moved to z=5 away from spawn

            // Final words to disciples
            createInteractable(-5, 0.5, -8, 'speak', 'Final Words to Disciples', [
                {speaker: "Vincent", text: "My beloved sons... continue preaching... fear God... save souls..."},
                {speaker: "Disciples", text: "Master, don't leave us! Who will guide the Church?"},
                {speaker: "Vincent", text: "*weakly* Christ... will guide you... I go to Him now..."}
            ]);

            // Receive last rites
            createInteractable(0, 0.5, -9, 'rites', 'Receive Last Rites', [
                {speaker: "Priest", text: "Through this holy anointing, may the Lord forgive you..."},
                {speaker: "Vincent", text: "Lord Jesus... into Thy hands... I commend my spirit..."},
                {speaker: "Narrator", text: "The bells of Vannes Cathedral rang by themselves. A brilliant light filled the room."},
                {speaker: "Witness", text: "The bells! They ring with no one pulling them! The saint goes to heaven!"}
            ], 'heal', 0);
            
            updateRadar();
        }

        function loadFuneralChapter() {
            createGround();
            createChurch(0, 0, -28, 'funeral-church');
            for(let i = 0; i < 55; i++) createNPC(-25 + Math.random() * 50, 0, -22 + Math.random() * 25, 0x000000);

            // Witness blind man healed
            createNPC(-15, 0, -18, 0x654321);
            createInteractable(-15, 1, -18, 'witness', 'Blind Man Healed at Tomb', [
                {speaker: "Blind Man", text: "I touched Vincent's holy body... and now... I SEE!"},
                {speaker: "You (Brother Thomas)", text: "Another miracle! Even in death he heals!"}
            ], 'heal', 0);

            // Cripple walks
            createNPC(-8, 0, -16, 0x8b4513);
            createInteractable(-8, 1, -16, 'witness', 'Cripple Walks', [
                {speaker: "Crippled Woman", text: "I crawled to his tomb on my knees... and now I WALK!"},
                {speaker: "You (Brother Thomas)", text: "The miracles continue! God glorifies His servant!"}
            ], 'heal', 0);

            // Deaf child hears
            createNPC(0, 0, -18, 0x2c3e50);
            createInteractable(0, 1, -18, 'witness', 'Deaf Child Hears', [
                {speaker: "Mother", text: "My son was born deaf! He never spoke! Touch the saint's tomb, child!"},
                {speaker: "Deaf Boy", text: "Mama! I hear you! I can talk!"},
                {speaker: "You (Brother Thomas)", text: "Blessed Vincent! Your power grows even stronger!"}
            ], 'heal', 0);

            // Dead child revived
            createNPC(8, 0, -16, 0x4a4a4a);
            createInteractable(8, 1, -16, 'witness', 'Dead Child Revived', [
                {speaker: "Father", text: "My daughter died this morning! I brought her to the saint!"},
                {speaker: "Dead Girl", text: "*gasps* Papa! I saw heaven... but I'm back..."},
                {speaker: "You (Brother Thomas)", text: "He raises the dead even from the grave! Incredible!"}
            ], 'heal', 0);

            // Record all miracles
            createInteractable(15, 0.5, -18, 'record', 'Record the Miracles', [
                {speaker: "You (Brother Thomas)", text: "I must write all these miracles down. The Church must know!"},
                {speaker: "Bishop", text: "Brother Thomas, you witnessed more than anyone. Your testimony will canonize him."}
            ], 'preach', 0);
            
            updateRadar();
        }

        function loadCanonizationChapter() {
            createGround();
            // Grand St. Peter's Basilica with proper door
            const basilica = new THREE.Mesh(
                new THREE.BoxGeometry(60, 35, 50),
                new THREE.MeshStandardMaterial({
                    color: 0xf5f5dc,
                    roughness: 0.65,
                    metalness: 0.15
                })
            );
            basilica.position.set(0, 17.5, -35);
            basilica.castShadow = true;
            basilica.receiveShadow = true;
            scene.add(basilica);
            
            // Add grand door to Vatican
            const vaticanDoor = createDoor(0, 0, -10, true, 'vatican');
            vaticanDoor.scale.set(1.5, 1.5, 1);
            doors.push(vaticanDoor);
            
            // Magnificent golden door frame
            const doorFrame = new THREE.Mesh(
                new THREE.BoxGeometry(6, 10, 0.5),
                new THREE.MeshStandardMaterial({
                    color: 0xffd700, 
                    roughness: 0.2, 
                    metalness: 0.9,
                    emissive: 0xffd700,
                    emissiveIntensity: 0.3
                })
            );
            doorFrame.position.set(0, 5, -9.7);
            doorFrame.castShadow = true;
            scene.add(doorFrame);
            
            buildings.push({x: 0, z: -35, radius: 30, id: 'vatican'});

            // OUTDOOR: Massive crowd celebrating (OUTSIDE)
            for(let i = 0; i < 60; i++) {
                createNPC(-25 + Math.random() * 50, 0, 5 + Math.random() * 20, 0x8b0000, false, null);
            }

            // INDOOR: Pope Callixtus III appears (INSIDE BASILICA)
            createNPC(0, 0, -8, 0xff0000, true, 'vatican');

            // INDOOR: Hear Pope's declaration (INSIDE)
            createInteractable(0, 0.5, -7, 'hear', 'Hear Papal Declaration', [
                {speaker: "Pope Callixtus III", text: "By the authority of Almighty God, we declare Vincent Ferrer to be a SAINT!"},
                {speaker: "Cardinals", text: "He is inscribed in the catalog of Saints! Let all Christians honor him!"},
                {speaker: "You (Brother Thomas)", text: "My teacher! My master! Now SAINT Vincent Ferrer!"}
            ], null, 0, true, 'vatican');

            // INDOOR: Celebrate with witnesses (INSIDE)
            for(let i = 0; i < 12; i++) createNPC(-10 + i * 2, 0, -8, 0x8b0000, true, 'vatican');
            createInteractable(-10, 0.5, -4, 'celebrate', 'Celebrate with Witnesses', [
                {speaker: "You (Brother Thomas)", text: "I witnessed his miracles! I saw him raise the dead!"},
                {speaker: "Other Witness", text: "I saw him speak in tongues! I saw him multiply food!"},
                {speaker: "Another Witness", text: "873 confirmed miracles! 25,000 Jews converted! 8,000 Muslims!"}
            ], 'preach', 100, true, 'vatican');

            // INDOOR: Final prayer (INSIDE)
            createInteractable(10, 0.5, -9, 'pray', 'Give Thanks to God', [
                {speaker: "You (Brother Thomas)", text: "Thank you, Lord, for letting me witness his holy life!"},
                {speaker: "All Present", text: "SAINT VINCENT FERRER, PRAY FOR US!"},
                {speaker: "Narrator", text: "The life of Saint Vincent Ferrer is complete. Your journey ends in glory."}
            ], 'heal', 500, true, 'vatican');
            
            updateRadar();
        }

        function onMouseMove(e) {
            if(isMobile) return;
            mouseX = (e.clientX / window.innerWidth) * 2 - 1;
            cameraAngle += e.movementX * 0.004;
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function update(dt) {
            if(gameState !== 'playing' || !playerModel) return;

            const speed = MOVE_SPEED * dt;
            const forward = new THREE.Vector3(Math.sin(cameraAngle), 0, Math.cos(cameraAngle));
            const right = new THREE.Vector3(Math.cos(cameraAngle), 0, -Math.sin(cameraAngle));

            let moveX = 0, moveZ = 0;
            isMoving = false;

            if(keys['w']) { moveX += forward.x * speed; moveZ += forward.z * speed; isMoving = true; }
            if(keys['s']) { moveX -= forward.x * speed; moveZ -= forward.z * speed; isMoving = true; }
            if(keys['a']) { moveX -= right.x * speed; moveZ -= right.z * speed; isMoving = true; }
            if(keys['d']) { moveX += right.x * speed; moveZ += right.z * speed; isMoving = true; }

            if(joyActive) {
                moveX -= right.x * joyDeltaX * speed;
                moveZ -= right.z * joyDeltaX * speed;
                moveX -= forward.x * joyDeltaY * speed;
                moveZ -= forward.z * joyDeltaY * speed;
                isMoving = true;
            }

            // Apply movement with collision
            const newX = playerModel.position.x + moveX;
            const newZ = playerModel.position.z + moveZ;

            if(!checkCollision(newX, playerModel.position.z)) {
                playerModel.position.x = newX;
            }
            if(!checkCollision(playerModel.position.x, newZ)) {
                playerModel.position.z = newZ;
            }

            // Animate walking
            if(isMoving && playerModel.userData.limbs) {
                walkCycle += dt * ANIMATION_SPEED;
                const limbs = playerModel.userData.limbs;
                
                if(limbs.leftArm) {
                    limbs.leftArm.rotation.x = Math.sin(walkCycle) * 0.6;
                    limbs.rightArm.rotation.x = Math.sin(walkCycle + Math.PI) * 0.6;
                }
                if(limbs.leftLeg) {
                    limbs.leftLeg.rotation.x = Math.sin(walkCycle + Math.PI) * 0.5;
                    limbs.rightLeg.rotation.x = Math.sin(walkCycle) * 0.5;
                }
            } else {
                // Reset to idle pose
                if(playerModel.userData.limbs) {
                    const limbs = playerModel.userData.limbs;
                    if(limbs.leftArm) {
                        limbs.leftArm.rotation.x = 0;
                        limbs.rightArm.rotation.x = 0;
                    }
                    if(limbs.leftLeg) {
                        limbs.leftLeg.rotation.x = 0;
                        limbs.rightLeg.rotation.x = 0;
                    }
                }
            }

            playerModel.rotation.y = cameraAngle;

            // Camera follow with better overhead angle for navigation
            cameraTarget.copy(playerModel.position);
            const camX = cameraTarget.x - Math.sin(cameraAngle) * CAMERA_DISTANCE;
            const camZ = cameraTarget.z - Math.cos(cameraAngle) * CAMERA_DISTANCE;
            camera.position.x = camX;
            camera.position.y = cameraTarget.y + CAMERA_HEIGHT;
            camera.position.z = camZ;
            // Look at point ahead of player for better forward visibility
            const lookAheadX = playerModel.position.x + Math.sin(cameraAngle) * 2;
            const lookAheadZ = playerModel.position.z + Math.cos(cameraAngle) * 2;
            camera.lookAt(lookAheadX, playerModel.position.y + 1.5, lookAheadZ);

            // Check interactions - DOORS FIRST, then tasks
            const nearestDoor = findNearestDoor();
            const nearest = findNearestInteractable();
            
            // Show/hide door button - independent of task system
            const doorButton = document.getElementById('door-button');
            if(nearestDoor) {
                doorButton.style.display = 'block';
                if(nearestDoor.userData.isOpen) {
                    if(nearestDoor.userData.leadsToInterior) {
                        doorButton.textContent = 'üö™ Enter Building';
                    } else if(nearestDoor.userData.leadsToExterior) {
                        doorButton.textContent = 'üö™ Exit Building';
                    } else {
                        doorButton.textContent = 'üö™ Pass Through Door';
                    }
                } else {
                    doorButton.textContent = 'üö™ Open Door';
                }
            } else {
                doorButton.style.display = 'none';
            }
            
            // Update objective text based on what's nearby - prioritize clarity
            if(nearestDoor) {
                if(!nearestDoor.userData.isOpen) {
                    document.getElementById('objective-text').textContent = 'üö™ DOOR - Use Door Button to Open';
                } else if(nearestDoor.userData.leadsToInterior) {
                    document.getElementById('objective-text').textContent = 'üö™ DOOR OPEN - Use Door Button to Enter';
                } else if(nearestDoor.userData.leadsToExterior) {
                    document.getElementById('objective-text').textContent = 'üö™ EXIT - Use Door Button to Leave';
                } else {
                    document.getElementById('objective-text').textContent = 'üö™ Door is open';
                }
            } else if(nearest) {
                document.getElementById('objective-text').textContent = `Press E: ${nearest.userData.label}`;
            } else {
                document.getElementById('objective-text').textContent = CHAPTERS[currentChapter].objective;
            }

            // Animate interactables (only visible ones)
            interactables.forEach(obj => {
                if(obj.visible === false) return; // Skip invisible indoor objects
                obj.position.y = 0.5 + Math.sin(Date.now() * 0.004 + obj.userData.floatOffset) * 0.35;
                obj.rotation.y += 0.04;
                obj.rotation.x = Math.sin(Date.now() * 0.002) * 0.2;
            });
            
            // Animate door beacons for maximum visibility
            scene.children.forEach(obj => {
                if(obj.userData && obj.userData.isDoorBeacon) {
                    // Float up and down
                    obj.position.y = obj.userData.baseY + Math.sin(Date.now() * 0.003) * 0.5;
                    // Pulse glow
                    if(obj.material) {
                        obj.material.emissiveIntensity = 2.0 + Math.sin(Date.now() * 0.005) * 1.0;
                    }
                }
            });
        }

        let lastTime = 0;
        let deltaAccumulator = 0;
        const FIXED_TIME_STEP = 1 / 60; // Target 60 FPS
        const MAX_DELTA = 0.1; // Prevent spiral of death
        
        function animate(time = 0) {
            requestAnimationFrame(animate);
            
            try {
                let dt = Math.min((time - lastTime) / 1000, MAX_DELTA);
                lastTime = time;
                
                // Smooth delta time for consistent physics
                deltaAccumulator += dt;
                while (deltaAccumulator >= FIXED_TIME_STEP) {
                    update(FIXED_TIME_STEP);
                    deltaAccumulator -= FIXED_TIME_STEP;
                }
                
                // FPS counter
                frameCount++;
                if(time - lastFrameTime >= 1000) {
                    fps = frameCount;
                    document.getElementById('fps-counter').textContent = `FPS: ${fps}`;
                    frameCount = 0;
                    lastFrameTime = time;
                }
                
                renderer.render(scene, camera);
            } catch(error) {
                console.error('Animation error:', error);
            }
        }

        init();
    </script>
</body>
</html>
