<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Saint Vincent Ferrer - Life Journey RPG</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; position: fixed; font-family: 'Georgia', serif; background: #000; }
        canvas { display: block; width: 100% !important; height: 100% !important; position: absolute; top: 0; left: 0; }
        #hud { position: fixed; top: 20px; left: 20px; background: rgba(20, 20, 40, 0.95); padding: 15px; border-radius: 10px; border: 2px solid #d4af37; color: #f0e6d2; font-size: 14px; z-index: 100; max-width: 300px; }
        #chapter-title { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.95); padding: 40px 60px; border: 3px solid #d4af37; border-radius: 15px; color: #d4af37; font-size: 32px; font-weight: bold; text-align: center; z-index: 200; display: none; max-width: 80%; }
        #dialogue-box { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); background: rgba(20, 20, 40, 0.98); padding: 25px 35px; border: 3px solid #d4af37; border-radius: 10px; color: #f0e6d2; font-size: 16px; max-width: 80%; z-index: 150; display: none; line-height: 1.8; text-align: center; }
        #dialogue-speaker { color: #d4af37; font-weight: bold; font-size: 18px; margin-bottom: 10px; text-align: center; }
        #dialogue-text { text-align: center; }
        #dialogue-continue { background: #d4af37; color: #1a1a2e; border: none; padding: 10px 25px; margin-top: 15px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; display: block; margin-left: auto; margin-right: auto; }
        #dialogue-continue:hover { background: #f0d978; }
        #controls { position: fixed; bottom: 20px; left: 20px; background: rgba(20, 20, 40, 0.9); padding: 15px; border-radius: 8px; color: #f0e6d2; font-size: 12px; z-index: 100; text-align: center; }
        #mobile-joystick { position: fixed; bottom: 40px; left: 40px; width: 150px; height: 150px; display: none; z-index: 200; }
        @media (max-width: 768px), (pointer: coarse) { #mobile-joystick { display: block; } #controls { display: none; } }
        .joystick-base { position: absolute; width: 150px; height: 150px; background: radial-gradient(circle, rgba(52, 73, 94, 0.7) 0%, rgba(44, 62, 80, 0.8) 100%); border: 3px solid rgba(212, 175, 55, 0.6); border-radius: 50%; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); }
        .joystick-stick { position: absolute; width: 60px; height: 60px; background: radial-gradient(circle, rgba(212, 175, 55, 0.9) 0%, rgba(160, 132, 40, 1) 100%); border: 3px solid rgba(160, 132, 40, 0.9); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: all 0.1s; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); }
        #interact-button { position: fixed; bottom: 50px; right: 50px; width: 80px; height: 80px; background: radial-gradient(circle, rgba(212, 175, 55, 0.9) 0%, rgba(160, 132, 40, 1) 100%); border: 4px solid rgba(160, 132, 40, 0.9); border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; color: white; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); z-index: 200; cursor: pointer; }
        @media (max-width: 768px), (pointer: coarse) { #interact-button { display: flex; } }
        #mission-objective { position: fixed; top: 20px; right: 20px; background: rgba(20, 20, 40, 0.95); padding: 15px; border-radius: 10px; border: 2px solid #4a9eff; color: #f0e6d2; font-size: 14px; z-index: 100; max-width: 300px; text-align: center; }
        #objective-title { color: #4a9eff; font-weight: bold; margin-bottom: 8px; }
        #task-progress { color: #ffd700; font-weight: bold; margin-top: 8px; font-size: 16px; }
        .miracle-effect { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 72px; color: #ffd700; text-shadow: 0 0 30px #fff, 0 0 60px #ffd700; z-index: 250; pointer-events: none; animation: miraclePulse 2s ease-out; }
        @keyframes miraclePulse { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1); } }
        #title-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a1a2e 0%, #2d1b4e 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 300; color: #d4af37; }
        #title-screen h1 { font-size: 48px; margin-bottom: 20px; text-shadow: 3px 3px 6px rgba(0,0,0,0.7); text-align: center; }
        #title-screen h2 { font-size: 24px; margin-bottom: 40px; color: #f0e6d2; text-align: center; }
        #start-button { background: #d4af37; color: #1a1a2e; border: none; padding: 20px 50px; font-size: 20px; font-weight: bold; border-radius: 10px; cursor: pointer; box-shadow: 0 6px 0 #a08428; transition: all 0.2s; }
        #start-button:hover { background: #f0d978; transform: translateY(-3px); box-shadow: 0 9px 0 #a08428; }
        #start-button:active { transform: translateY(3px); box-shadow: 0 3px 0 #a08428; }
        #playing-as { position: fixed; top: 90px; left: 20px; background: rgba(139, 0, 139, 0.9); padding: 10px 15px; border-radius: 8px; border: 2px solid #d4af37; color: #ffd700; font-size: 14px; font-weight: bold; z-index: 100; text-align: center; }
        #next-chapter-button { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #4a9eff; color: white; border: none; padding: 15px 40px; font-size: 18px; font-weight: bold; border-radius: 10px; cursor: pointer; box-shadow: 0 6px 0 #2c5aa0; z-index: 200; display: none; }
        #next-chapter-button:hover { background: #6fb1ff; }
        #next-chapter-button:active { transform: translateX(-50%) translateY(3px); box-shadow: 0 3px 0 #2c5aa0; }
        #fullscreen-button { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(74, 158, 255, 0.9); color: white; border: 3px solid #4a9eff; padding: 12px 30px; font-size: 16px; font-weight: bold; border-radius: 10px; cursor: pointer; z-index: 300; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        #fullscreen-button:hover { background: rgba(111, 177, 255, 0.9); }
        #fullscreen-button:active { transform: translateX(-50%) translateY(2px); }
        #mini-radar { position: fixed; bottom: 20px; right: 20px; width: 150px; height: 150px; background: rgba(20, 20, 40, 0.9); border: 3px solid #4a9eff; border-radius: 50%; z-index: 100; }
        .radar-player { position: absolute; width: 8px; height: 8px; background: #00ff00; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 10px #00ff00; }
        .radar-objective { position: absolute; width: 10px; height: 10px; background: #ffd700; border-radius: 50%; box-shadow: 0 0 10px #ffd700; animation: radarPulse 1s infinite; }
        @keyframes radarPulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } }
        .radar-scan { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: conic-gradient(transparent 0deg, rgba(74, 158, 255, 0.3) 90deg, transparent 90deg); animation: radarScan 3s linear infinite; }
        @keyframes radarScan { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="title-screen">
        <h1>‚úùÔ∏è SAINT VINCENT FERRER ‚úùÔ∏è</h1>
        <h2>The Life and Miracles</h2>
        <p style="max-width: 600px; text-align: center; margin: 20px; color: #f0e6d2; line-height: 1.6;">
            "The fear of the Lord is the beginning of wisdom" - Proverbs 9:10<br><br>
            Experience the miraculous life of the great Dominican preacher<br>
            <strong>Third-Person Action RPG</strong>
        </p>
        <button id="start-button">Begin Journey</button>
    </div>
    <div id="chapter-title"></div>
    <div id="playing-as">Playing as: Mother Constance</div>
    <div id="hud">
        <div style="text-align: center;"><strong>Chapter:</strong><br><span id="current-chapter">Prologue</span></div>
        <div style="text-align: center; margin-top: 8px;"><strong>Location:</strong><br><span id="current-location">Valencia</span></div>
        <div style="text-align: center; margin-top: 8px;"><strong>Year:</strong><br><span id="current-year">1350</span></div>
        <div style="text-align: center; margin-top: 8px;"><strong>Souls Converted:</strong><br><span id="souls-converted">0</span></div>
    </div>
    <div id="mission-objective">
        <div id="objective-title">Current Mission</div>
        <div id="objective-text">Wait for instructions...</div>
        <div id="task-progress">0 / 0 Tasks</div>
    </div>
    <div id="dialogue-box">
        <div id="dialogue-speaker"></div>
        <div id="dialogue-text"></div>
        <button id="dialogue-continue">Continue</button>
    </div>
    <div id="controls"><strong>WASD:</strong> Move | <strong>Mouse:</strong> Camera | <strong>E:</strong> Interact</div>
    <div id="mobile-joystick"><div class="joystick-base"></div><div class="joystick-stick"></div></div>
    <button id="interact-button">E</button>
    <button id="next-chapter-button">Continue to Next Chapter ‚Üí</button>
    <button id="fullscreen-button">Enter Fullscreen üì±</button>
    
    <div id="mini-radar">
        <div class="radar-scan"></div>
        <div class="radar-player"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        'use strict';

        // Constants
        const MOVE_SPEED = 10;
        const CAMERA_DISTANCE = 8;
        const CAMERA_HEIGHT = 5;
        const COLLISION_DISTANCE = 1.5;

        // Chapter definitions
        const CHAPTERS = {
            WOMB_BARKING: {
                name: "In the Womb - The Barking", 
                year: 1349, 
                location: "Valencia, Spain",
                playAs: "Mother Constance",
                tasks: 2,
                objective: "Talk to William and witness the barking"
            },
            WOMB_HEALING: {
                name: "In the Womb - Healing the Blind", 
                year: 1349, 
                location: "Valencia, Spain",
                playAs: "Mother Constance",
                tasks: 1,
                objective: "Touch blind woman to heal her"
            },
            BIRTH: {
                name: "The Miraculous Birth", 
                year: 1350, 
                location: "Valencia, Spain",
                playAs: "Mother Constance",
                tasks: 1,
                objective: "Give birth to Vincent"
            },
            CHILDHOOD: {
                name: "Childhood Calling", 
                year: 1360, 
                location: "Valencia",
                playAs: "Young Vincent",
                tasks: 2,
                objective: "Pray at church and talk to father"
            },
            DOMINICAN: {
                name: "Becoming a Dominican", 
                year: 1367, 
                location: "Valencia",
                playAs: "Saint Vincent Ferrer",
                tasks: 1,
                objective: "Take vows at the monastery"
            },
            PREACHING: {
                name: "Great Preacher", 
                year: 1400, 
                location: "Europe",
                playAs: "Saint Vincent Ferrer",
                tasks: 5,
                objective: "Preach to 5 groups of people"
            },
            SYNAGOGUE: {
                name: "Converting Synagogues", 
                year: 1411, 
                location: "Toledo, Spain",
                playAs: "Saint Vincent Ferrer",
                tasks: 3,
                objective: "Preach in Hebrew to 3 Jewish groups"
            },
            MOSQUE: {
                name: "Mission to Mosques", 
                year: 1412, 
                location: "Granada, Spain",
                playAs: "Saint Vincent Ferrer",
                tasks: 3,
                objective: "Preach in Arabic to 3 Muslim groups"
            },
            CHILD_REVIVAL: {
                name: "Raising Dead Children", 
                year: 1405, 
                location: "Spain",
                playAs: "Saint Vincent Ferrer",
                tasks: 2,
                objective: "Raise 2 dead children to life"
            },
            WINGS: {
                name: "The Angelic Flight", 
                year: 1405, 
                location: "Barcelona",
                playAs: "Saint Vincent Ferrer",
                tasks: 1,
                objective: "Fly to save drowning man"
            },
            RESURRECTION: {
                name: "Raising the Dead", 
                year: 1410, 
                location: "Salamanca",
                playAs: "Saint Vincent Ferrer",
                tasks: 1,
                objective: "Command the corpse to testify"
            },
            DEATH: {
                name: "The Holy Death", 
                year: 1419, 
                location: "Vannes, Brittany",
                playAs: "Saint Vincent Ferrer",
                tasks: 1,
                objective: "Receive last rites"
            },
            FUNERAL: {
                name: "Funeral Miracles", 
                year: 1419, 
                location: "Vannes Cathedral",
                playAs: "Brother Thomas (Pupil)",
                tasks: 3,
                objective: "Witness 3 funeral miracles"
            },
            CANONIZATION: {
                name: "Declaration of Sainthood", 
                year: 1455, 
                location: "Rome, Vatican",
                playAs: "Brother Thomas (Pupil)",
                tasks: 1,
                objective: "Hear Pope's declaration"
            }
        };

        // Game State
        let scene, camera, renderer, gameState = 'title';
        let currentChapter = 'WOMB_BARKING';
        let playerModel, cameraTarget = new THREE.Vector3();
        let tasksCompleted = 0, tasksRequired = 0;
        let canFly = false, soulsConverted = 0, dialogueQueue = [];
        let audioContext, masterGain;
        const keys = {}, interactables = [], buildings = [], doors = [];
        let mouseX = 0, mouseY = 0, cameraAngle = 0;
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent);
        let joyActive = false, joyStartX = 0, joyStartY = 0, joyDeltaX = 0, joyDeltaY = 0;
        let isIndoors = false, currentBuilding = null;

        // Gregorian Chant
        const GREGORIAN_SCALE = {
            D3: 146.83, E3: 164.81, F3: 174.61, G3: 196.00, A3: 220.00, B3: 246.94, 
            C4: 261.63, D4: 293.66, E4: 329.63, F4: 349.23, G4: 392.00, A4: 440.00
        };
        const CHANTS = {
            KYRIE: [{note:'D4',dur:1.0},{note:'F4',dur:0.5},{note:'G4',dur:0.5},{note:'A4',dur:1.5}]
        };

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.FogExp2(0x87CEEB, 0.008);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.physicallyCorrectLights = true;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            document.body.appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            
            const sunLight = new THREE.DirectionalLight(0xfff5e6, 2.5);
            sunLight.position.set(50, 100, 50);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 4096;
            sunLight.shadow.mapSize.height = 4096;
            sunLight.shadow.camera.left = -100;
            sunLight.shadow.camera.right = 100;
            sunLight.shadow.camera.top = 100;
            sunLight.shadow.camera.bottom = -100;
            scene.add(sunLight);

            const fillLight = new THREE.DirectionalLight(0x9db4ff, 0.5);
            fillLight.position.set(-50, 50, -50);
            scene.add(fillLight);

            document.getElementById('start-button').addEventListener('click', startGame);
            document.getElementById('dialogue-continue').addEventListener('click', advanceDialogue);
            document.getElementById('interact-button').addEventListener('click', tryInteract);
            document.getElementById('next-chapter-button').addEventListener('click', nextChapter);
            document.getElementById('fullscreen-button').addEventListener('click', toggleFullscreen);
            document.addEventListener('keydown', e => { 
                keys[e.key.toLowerCase()] = true; 
                if(e.key.toLowerCase() === 'e') tryInteract();
            });
            document.addEventListener('keyup', e => { keys[e.key.toLowerCase()] = false; });
            document.addEventListener('mousemove', onMouseMove);
            window.addEventListener('resize', onResize);

            if(isMobile) setupMobileJoystick();
            initAudio();
            animate();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement) {
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
                document.getElementById('fullscreen-button').textContent = 'Exit Fullscreen ‚úï';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                document.getElementById('fullscreen-button').textContent = 'Enter Fullscreen üì±';
            }
        }

        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                masterGain = audioContext.createGain();
                masterGain.connect(audioContext.destination);
                masterGain.gain.value = 0.1;
            } catch(e) {}
        }

        function playChant(name = 'KYRIE') {
            if(!audioContext) return;
            const chant = CHANTS[name] || CHANTS.KYRIE;
            let time = audioContext.currentTime;
            chant.forEach(n => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.frequency.value = GREGORIAN_SCALE[n.note];
                gain.gain.setValueAtTime(0, time);
                gain.gain.linearRampToValueAtTime(0.5, time + 0.1);
                gain.gain.linearRampToValueAtTime(0, time + n.dur);
                osc.connect(gain);
                gain.connect(masterGain);
                osc.start(time);
                osc.stop(time + n.dur);
                time += n.dur;
            });
        }

        function setupMobileJoystick() {
            const stick = document.querySelector('.joystick-stick');
            const base = document.querySelector('.joystick-base');
            base.addEventListener('touchstart', e => {
                e.preventDefault();
                joyActive = true;
                const rect = base.getBoundingClientRect();
                joyStartX = rect.left + rect.width/2;
                joyStartY = rect.top + rect.height/2;
            });
            base.addEventListener('touchmove', e => {
                if(!joyActive) return;
                e.preventDefault();
                const touch = e.touches[0];
                const dx = touch.clientX - joyStartX;
                const dy = touch.clientY - joyStartY;
                const dist = Math.min(50, Math.sqrt(dx*dx + dy*dy));
                const angle = Math.atan2(dy, dx);
                joyDeltaX = Math.cos(angle) * (dist/50);
                joyDeltaY = Math.sin(angle) * (dist/50);
                stick.style.transform = `translate(calc(-50% + ${dist*Math.cos(angle)}px), calc(-50% + ${dist*Math.sin(angle)}px))`;
            });
            base.addEventListener('touchend', e => {
                e.preventDefault();
                joyActive = false;
                joyDeltaX = 0; joyDeltaY = 0;
                stick.style.transform = 'translate(-50%, -50%)';
            });
        }

        function startGame() {
            document.getElementById('title-screen').style.display = 'none';
            gameState = 'playing';
            loadChapter('WOMB_BARKING');
            playChant('KYRIE');
        }

        function loadChapter(key) {
            currentChapter = key;
            const ch = CHAPTERS[key];
            document.getElementById('current-chapter').textContent = ch.name;
            document.getElementById('current-location').textContent = ch.location;
            document.getElementById('current-year').textContent = ch.year;
            document.getElementById('playing-as').textContent = 'Playing as: ' + ch.playAs;
            document.getElementById('objective-text').textContent = ch.objective;
            tasksRequired = ch.tasks;
            tasksCompleted = 0;
            updateTaskProgress();
            showChapterTitle(ch.name);
            clearScene();
            interactables.length = 0;
            buildings.length = 0;
            doors.length = 0;
            isIndoors = false;
            currentBuilding = null;
            document.getElementById('next-chapter-button').style.display = 'none';

            // Create player model
            if(ch.playAs.includes('Mother')) {
                playerModel = createMotherModel();
            } else if(ch.playAs.includes('Young Vincent')) {
                playerModel = createYoungVincentModel();
            } else if(ch.playAs.includes('Vincent')) {
                playerModel = createVincentModel();
            } else if(ch.playAs.includes('Thomas')) {
                playerModel = createPupilModel();
            }
            playerModel.position.set(0, 0, 0);
            scene.add(playerModel);

            // Load chapter content
            switch(key) {
                case 'WOMB_BARKING': loadWombBarkingChapter(); break;
                case 'WOMB_HEALING': loadWombHealingChapter(); break;
                case 'BIRTH': loadBirthChapter(); break;
                case 'CHILDHOOD': loadChildhoodChapter(); break;
                case 'DOMINICAN': loadDominicanChapter(); break;
                case 'PREACHING': loadPreachingChapter(); break;
                case 'SYNAGOGUE': loadSynagogueChapter(); break;
                case 'MOSQUE': loadMosqueChapter(); break;
                case 'CHILD_REVIVAL': loadChildRevivalChapter(); break;
                case 'WINGS': loadWingsChapter(); break;
                case 'RESURRECTION': loadResurrectionChapter(); break;
                case 'DEATH': loadDeathChapter(); break;
                case 'FUNERAL': loadFuneralChapter(); break;
                case 'CANONIZATION': loadCanonizationChapter(); break;
            }
        }

        function showChapterTitle(title) {
            const el = document.getElementById('chapter-title');
            el.innerHTML = `<div style="font-size: 32px; margin-bottom: 15px;">${title}</div>
                <div style="font-size: 18px; color: #f0e6d2;">Complete all tasks to continue</div>`;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 4000);
        }

        function clearScene() {
            while(scene.children.length > 0) { 
                const obj = scene.children[0];
                if(obj.geometry) obj.geometry.dispose();
                if(obj.material) {
                    if(Array.isArray(obj.material)) obj.material.forEach(m => m.dispose());
                    else obj.material.dispose();
                }
                scene.remove(obj);
            }
            const ambient = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambient);
            const sun = new THREE.DirectionalLight(0xfff5e6, 2.5);
            sun.position.set(50, 100, 50);
            sun.castShadow = true;
            sun.shadow.mapSize.width = 4096;
            sun.shadow.mapSize.height = 4096;
            scene.add(sun);
            const fill = new THREE.DirectionalLight(0x9db4ff, 0.5);
            fill.position.set(-50, 50, -50);
            scene.add(fill);
        }

        function updateTaskProgress() {
            document.getElementById('task-progress').textContent = `${tasksCompleted} / ${tasksRequired} Tasks`;
            if(tasksCompleted >= tasksRequired) {
                document.getElementById('next-chapter-button').style.display = 'block';
                showMiracle('‚ú® CHAPTER COMPLETE! ‚ú®');
            }
        }

        function nextChapter() {
            const chapters = Object.keys(CHAPTERS);
            const currentIdx = chapters.indexOf(currentChapter);
            if(currentIdx < chapters.length - 1) {
                loadChapter(chapters[currentIdx + 1]);
            } else {
                showGameComplete();
            }
        }

        function showGameComplete() {
            document.getElementById('chapter-title').innerHTML = `
                <div style="color:#d4af37; font-size:42px;">‚úùÔ∏è JOURNEY COMPLETE ‚úùÔ∏è</div>
                <div style="color:#f0e6d2; font-size:18px; margin-top:20px; line-height:1.8;">
                    You have lived the miraculous life of<br>
                    <strong style="color:#d4af37; font-size:24px;">SAINT VINCENT FERRER</strong><br><br>
                    <strong style="color:#4a9eff;">Total Souls Converted: ${soulsConverted}</strong><br><br>
                    "Fear the Lord and give Him glory" - Revelation 14:7<br><br>
                    Saint Vincent Ferrer, pray for us!<br><br>
                    <div style="font-size:14px; margin-top:15px;">Refresh to play again</div>
                </div>
            `;
            document.getElementById('chapter-title').style.display = 'block';
        }

        function showDialogue(dlg) {
            if(!dlg) { 
                document.getElementById('dialogue-box').style.display = 'none'; 
                return; 
            }
            document.getElementById('dialogue-speaker').textContent = dlg.speaker;
            document.getElementById('dialogue-text').textContent = dlg.text;
            document.getElementById('dialogue-box').style.display = 'block';
        }

        function advanceDialogue() {
            dialogueQueue.shift();
            if(dialogueQueue.length > 0) {
                showDialogue(dialogueQueue[0]);
            } else {
                document.getElementById('dialogue-box').style.display = 'none';
            }
        }

        function tryInteract() {
            // Check for doors first
            const nearestDoor = findNearestDoor();
            if(nearestDoor) {
                openDoor(nearestDoor);
                return;
            }
            
            // Then check for regular interactables
            const nearest = findNearestInteractable();
            if(nearest) {
                executeInteraction(nearest);
            }
        }

        function findNearestDoor() {
            if(!playerModel) return null;
            let nearest = null;
            let nearestDist = 3;
            doors.forEach(door => {
                const dist = playerModel.position.distanceTo(door.position);
                if(dist < nearestDist) {
                    nearest = door;
                    nearestDist = dist;
                }
            });
            return nearest;
        }

        function openDoor(door) {
            if(door.userData.isOpen) {
                // Door already open, pass through
                return;
            }
            
            // Open the door
            door.userData.isOpen = true;
            
            // Animate door opening
            const openAngle = door.userData.openAngle || Math.PI/2;
            const targetRotation = door.rotation.y + openAngle;
            
            let currentRot = door.rotation.y;
            const animateDoor = () => {
                currentRot += 0.1;
                door.rotation.y = currentRot;
                if(currentRot < targetRotation) {
                    requestAnimationFrame(animateDoor);
                } else {
                    door.rotation.y = targetRotation;
                }
            };
            animateDoor();
            
            // If this door leads to interior, transition
            if(door.userData.leadsToInterior) {
                setTimeout(() => {
                    enterBuilding(door.userData.buildingId);
                }, 500);
            } else if(door.userData.leadsToExterior) {
                setTimeout(() => {
                    exitBuilding();
                }, 500);
            }
        }

        function enterBuilding(buildingId) {
            isIndoors = true;
            currentBuilding = buildingId;
            
            // Clear exterior
            clearSceneObjects();
            
            // Create interior
            createBuildingInterior(buildingId);
            
            // Position player inside
            playerModel.position.set(0, 0, 5);
            
            showMiracle('Entered Building');
        }

        function exitBuilding() {
            isIndoors = false;
            const lastBuilding = currentBuilding;
            currentBuilding = null;
            
            // Clear interior
            clearSceneObjects();
            
            // Reload current chapter exterior
            loadChapter(currentChapter);
            
            // Position player outside building
            if(lastBuilding) {
                const building = buildings.find(b => b.id === lastBuilding);
                if(building) {
                    playerModel.position.set(building.x, 0, building.z + 10);
                }
            }
            
            showMiracle('Exited Building');
        }

        function clearSceneObjects() {
            // Remove all scene objects except lights and camera
            const objectsToRemove = [];
            scene.children.forEach(obj => {
                if(obj.type !== 'AmbientLight' && obj.type !== 'DirectionalLight' && obj !== camera && obj !== playerModel) {
                    objectsToRemove.push(obj);
                }
            });
            objectsToRemove.forEach(obj => {
                if(obj.geometry) obj.geometry.dispose();
                if(obj.material) {
                    if(Array.isArray(obj.material)) obj.material.forEach(m => m.dispose());
                    else obj.material.dispose();
                }
                scene.remove(obj);
            });
        }

        function createBuildingInterior(buildingId) {
            // Create interior floor
            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(20, 20),
                new THREE.MeshStandardMaterial({color: 0x8b7355, roughness: 0.9})
            );
            floor.rotation.x = -Math.PI/2;
            floor.receiveShadow = true;
            scene.add(floor);
            
            // Create walls
            const wallMaterial = new THREE.MeshStandardMaterial({color: 0xd4a373, roughness: 0.9});
            
            // Back wall
            const backWall = new THREE.Mesh(
                new THREE.BoxGeometry(20, 6, 0.5),
                wallMaterial
            );
            backWall.position.set(0, 3, -10);
            backWall.castShadow = true;
            backWall.receiveShadow = true;
            scene.add(backWall);
            
            // Left wall
            const leftWall = new THREE.Mesh(
                new THREE.BoxGeometry(0.5, 6, 20),
                wallMaterial
            );
            leftWall.position.set(-10, 3, 0);
            leftWall.castShadow = true;
            leftWall.receiveShadow = true;
            scene.add(leftWall);
            
            // Right wall
            const rightWall = new THREE.Mesh(
                new THREE.BoxGeometry(0.5, 6, 20),
                wallMaterial
            );
            rightWall.position.set(10, 3, 0);
            rightWall.castShadow = true;
            rightWall.receiveShadow = true;
            scene.add(rightWall);
            
            // Front wall with door opening
            const frontWallLeft = new THREE.Mesh(
                new THREE.BoxGeometry(7, 6, 0.5),
                wallMaterial
            );
            frontWallLeft.position.set(-6.5, 3, 10);
            frontWallLeft.castShadow = true;
            scene.add(frontWallLeft);
            
            const frontWallRight = new THREE.Mesh(
                new THREE.BoxGeometry(7, 6, 0.5),
                wallMaterial
            );
            frontWallRight.position.set(6.5, 3, 10);
            frontWallRight.castShadow = true;
            scene.add(frontWallRight);
            
            // Exit door (interior side)
            const exitDoor = createDoor(0, 0, 9.5, false, null, true);
            doors.push(exitDoor);
            
            // Add furniture based on building type
            if(buildingId && buildingId.includes('house')) {
                // Add bed
                const bed = new THREE.Mesh(
                    new THREE.BoxGeometry(3, 0.5, 4),
                    new THREE.MeshStandardMaterial({color: 0x8b4513})
                );
                bed.position.set(-5, 0.5, -5);
                bed.castShadow = true;
                scene.add(bed);
                
                // Add table
                const table = new THREE.Mesh(
                    new THREE.BoxGeometry(3, 0.2, 2),
                    new THREE.MeshStandardMaterial({color: 0x654321})
                );
                table.position.set(5, 1.5, -3);
                table.castShadow = true;
                scene.add(table);
            } else if(buildingId && buildingId.includes('church')) {
                // Add altar
                const altar = new THREE.Mesh(
                    new THREE.BoxGeometry(4, 1.5, 2),
                    new THREE.MeshStandardMaterial({color: 0xd4af37, metalness: 0.5})
                );
                altar.position.set(0, 0.75, -8);
                altar.castShadow = true;
                scene.add(altar);
                
                // Add cross on altar
                const cross = new THREE.Group();
                const crossV = new THREE.Mesh(
                    new THREE.BoxGeometry(0.2, 1.5, 0.2),
                    new THREE.MeshStandardMaterial({color: 0xffd700, emissive: 0xffd700, emissiveIntensity: 0.5})
                );
                crossV.position.y = 0.75;
                cross.add(crossV);
                const crossH = new THREE.Mesh(
                    new THREE.BoxGeometry(1, 0.2, 0.2),
                    new THREE.MeshStandardMaterial({color: 0xffd700, emissive: 0xffd700, emissiveIntensity: 0.5})
                );
                crossH.position.y = 0.5;
                cross.add(crossH);
                cross.position.set(0, 1.5, -8);
                scene.add(cross);
            }
            
            // Add interior lighting
            const interiorLight = new THREE.PointLight(0xffa500, 1.5, 20);
            interiorLight.position.set(0, 5, 0);
            scene.add(interiorLight);
        }

        function findNearestInteractable() {
            if(!playerModel) return null;
            let nearest = null;
            let nearestDist = 3;
            interactables.forEach(obj => {
                const dist = playerModel.position.distanceTo(obj.position);
                if(dist < nearestDist) {
                    nearest = obj;
                    nearestDist = dist;
                }
            });
            return nearest;
        }

        function executeInteraction(obj) {
            scene.remove(obj);
            const idx = interactables.indexOf(obj);
            if(idx > -1) interactables.splice(idx, 1);
            
            tasksCompleted++;
            updateTaskProgress();
            updateRadar();
            
            if(obj.userData.dialogue) {
                dialogueQueue = obj.userData.dialogue;
                showDialogue(dialogueQueue[0]);
            }
            
            if(obj.userData.effect === 'heal') {
                createMiracleEffect(obj.position.x, obj.position.y + 1, obj.position.z, 0xffffff);
                addConversions(obj.userData.souls || 10);
            } else if(obj.userData.effect === 'preach') {
                createMiracleEffect(obj.position.x, obj.position.y + 1, obj.position.z, 0xffd700);
                addConversions(obj.userData.souls || 50);
            } else if(obj.userData.effect === 'convert') {
                createMiracleEffect(obj.position.x, obj.position.y + 1, obj.position.z, 0x4a9eff);
                addConversions(obj.userData.souls || 25);
            }
        }

        function addConversions(count) {
            soulsConverted += count;
            document.getElementById('souls-converted').textContent = soulsConverted;
            showMiracle(`+${count} Souls!`);
        }

        function showMiracle(text) {
            const el = document.createElement('div');
            el.className = 'miracle-effect';
            el.textContent = text;
            document.body.appendChild(el);
            setTimeout(() => document.body.removeChild(el), 2000);
        }

        function updateRadar() {
            const radar = document.getElementById('mini-radar');
            const existing = radar.querySelectorAll('.radar-objective');
            existing.forEach(e => e.remove());

            if(!playerModel) return;

            interactables.forEach(obj => {
                const dx = obj.position.x - playerModel.position.x;
                const dz = obj.position.z - playerModel.position.z;
                const dist = Math.sqrt(dx*dx + dz*dz);
                
                if(dist < 50) {
                    const radarX = (dx / 50) * 65 + 75;
                    const radarY = (dz / 50) * 65 + 75;
                    
                    const dot = document.createElement('div');
                    dot.className = 'radar-objective';
                    dot.style.left = radarX + 'px';
                    dot.style.top = radarY + 'px';
                    radar.appendChild(dot);
                }
            });
        }

        function checkCollision(newX, newZ) {
            for(let building of buildings) {
                const dx = newX - building.x;
                const dz = newZ - building.z;
                const dist = Math.sqrt(dx*dx + dz*dz);
                
                if(dist < building.radius + COLLISION_DISTANCE) {
                    return true;
                }
            }
            return false;
        }

        // PLAYER MODEL CREATORS
        function createMotherModel() {
            const group = new THREE.Group();
            const dress = new THREE.Mesh(
                new THREE.CylinderGeometry(0.4, 0.5, 1.4, 16),
                new THREE.MeshStandardMaterial({color: 0x8b4789, roughness: 0.7, metalness: 0.1})
            );
            dress.position.y = 0.7;
            dress.castShadow = true;
            group.add(dress);
            
            const head = new THREE.Mesh(
                new THREE.SphereGeometry(0.25, 16, 16),
                new THREE.MeshStandardMaterial({color: 0xf0c291, roughness: 0.5})
            );
            head.position.y = 1.6;
            head.castShadow = true;
            group.add(head);
            
            // Arms
            const armGeo = new THREE.CylinderGeometry(0.08, 0.08, 0.7, 8);
            const armMat = new THREE.MeshStandardMaterial({color: 0xf0c291, roughness: 0.5});
            const leftArm = new THREE.Mesh(armGeo, armMat);
            leftArm.position.set(-0.45, 0.8, 0);
            leftArm.rotation.z = 0.4;
            leftArm.castShadow = true;
            group.add(leftArm);
            const rightArm = new THREE.Mesh(armGeo, armMat);
            rightArm.position.set(0.45, 0.8, 0);
            rightArm.rotation.z = -0.4;
            rightArm.castShadow = true;
            group.add(rightArm);
            
            return group;
        }

        function createYoungVincentModel() {
            const group = new THREE.Group();
            const body = new THREE.Mesh(
                new THREE.CylinderGeometry(0.25, 0.3, 1, 16),
                new THREE.MeshStandardMaterial({color: 0x4a4a4a, roughness: 0.8})
            );
            body.position.y = 0.5;
            body.castShadow = true;
            group.add(body);
            
            const head = new THREE.Mesh(
                new THREE.SphereGeometry(0.2, 16, 16),
                new THREE.MeshStandardMaterial({color: 0xf0c291, roughness: 0.5})
            );
            head.position.y = 1.2;
            head.castShadow = true;
            group.add(head);
            
            // Arms and legs for young Vincent
            const armGeo = new THREE.CylinderGeometry(0.06, 0.06, 0.5, 8);
            const armMat = new THREE.MeshStandardMaterial({color: 0xf0c291, roughness: 0.5});
            const leftArm = new THREE.Mesh(armGeo, armMat);
            leftArm.position.set(-0.35, 0.6, 0);
            leftArm.rotation.z = 0.3;
            leftArm.castShadow = true;
            group.add(leftArm);
            const rightArm = new THREE.Mesh(armGeo, armMat);
            rightArm.position.set(0.35, 0.6, 0);
            rightArm.rotation.z = -0.3;
            rightArm.castShadow = true;
            group.add(rightArm);
            
            const legGeo = new THREE.CylinderGeometry(0.08, 0.07, 0.5, 8);
            const legMat = new THREE.MeshStandardMaterial({color: 0x2c3e50, roughness: 0.8});
            const leftLeg = new THREE.Mesh(legGeo, legMat);
            leftLeg.position.set(-0.12, 0.15, 0);
            leftLeg.castShadow = true;
            group.add(leftLeg);
            const rightLeg = new THREE.Mesh(legGeo, legMat);
            rightLeg.position.set(0.12, 0.15, 0);
            rightLeg.castShadow = true;
            group.add(rightLeg);
            
            return group;
        }

        function createVincentModel() {
            const group = new THREE.Group();
            const habit = new THREE.Mesh(
                new THREE.CylinderGeometry(0.35, 0.4, 1.4, 16),
                new THREE.MeshStandardMaterial({color: 0x000000, roughness: 0.9})
            );
            habit.position.y = 0.7;
            habit.castShadow = true;
            group.add(habit);
            
            const scapular = new THREE.Mesh(
                new THREE.BoxGeometry(0.6, 1.2, 0.05),
                new THREE.MeshStandardMaterial({color: 0xffffff, roughness: 0.7})
            );
            scapular.position.set(0, 0.7, 0.22);
            scapular.castShadow = true;
            group.add(scapular);
            
            const head = new THREE.Mesh(
                new THREE.SphereGeometry(0.25, 16, 16),
                new THREE.MeshStandardMaterial({color: 0xf0c291, roughness: 0.5})
            );
            head.position.y = 1.6;
            head.castShadow = true;
            group.add(head);
            
            const halo = new THREE.Mesh(
                new THREE.TorusGeometry(0.35, 0.04, 16, 32),
                new THREE.MeshStandardMaterial({
                    color: 0xffd700,
                    emissive: 0xffd700,
                    emissiveIntensity: 1.0
                })
            );
            halo.position.y = 2;
            halo.rotation.x = Math.PI/2;
            group.add(halo);
            
            // Arms and legs
            const armGeo = new THREE.CylinderGeometry(0.08, 0.08, 0.7, 8);
            const armMat = new THREE.MeshStandardMaterial({color: 0xf0c291, roughness: 0.5});
            const leftArm = new THREE.Mesh(armGeo, armMat);
            leftArm.position.set(-0.45, 0.8, 0);
            leftArm.rotation.z = 0.3;
            leftArm.castShadow = true;
            group.add(leftArm);
            const rightArm = new THREE.Mesh(armGeo, armMat);
            rightArm.position.set(0.45, 0.8, 0);
            rightArm.rotation.z = -0.3;
            rightArm.castShadow = true;
            group.add(rightArm);
            
            const legGeo = new THREE.CylinderGeometry(0.09, 0.08, 0.5, 8);
            const legMat = new THREE.MeshStandardMaterial({color: 0x000000, roughness: 0.9});
            const leftLeg = new THREE.Mesh(legGeo, legMat);
            leftLeg.position.set(-0.15, 0.15, 0);
            leftLeg.castShadow = true;
            group.add(leftLeg);
            const rightLeg = new THREE.Mesh(legGeo, legMat);
            rightLeg.position.set(0.15, 0.15, 0);
            rightLeg.castShadow = true;
            group.add(rightLeg);
            
            return group;
        }

        function createPupilModel() {
            const group = new THREE.Group();
            const robe = new THREE.Mesh(
                new THREE.CylinderGeometry(0.35, 0.4, 1.4, 16),
                new THREE.MeshStandardMaterial({color: 0x8b4513, roughness: 0.9})
            );
            robe.position.y = 0.7;
            robe.castShadow = true;
            group.add(robe);
            
            const head = new THREE.Mesh(
                new THREE.SphereGeometry(0.25, 16, 16),
                new THREE.MeshStandardMaterial({color: 0xf0c291, roughness: 0.5})
            );
            head.position.y = 1.6;
            head.castShadow = true;
            group.add(head);
            
            // Arms and legs
            const armGeo = new THREE.CylinderGeometry(0.08, 0.08, 0.7, 8);
            const armMat = new THREE.MeshStandardMaterial({color: 0xf0c291, roughness: 0.5});
            const leftArm = new THREE.Mesh(armGeo, armMat);
            leftArm.position.set(-0.45, 0.8, 0);
            leftArm.rotation.z = 0.3;
            leftArm.castShadow = true;
            group.add(leftArm);
            const rightArm = new THREE.Mesh(armGeo, armMat);
            rightArm.position.set(0.45, 0.8, 0);
            rightArm.rotation.z = -0.3;
            rightArm.castShadow = true;
            group.add(rightArm);
            
            const legGeo = new THREE.CylinderGeometry(0.09, 0.08, 0.5, 8);
            const legMat = new THREE.MeshStandardMaterial({color: 0x654321, roughness: 0.9});
            const leftLeg = new THREE.Mesh(legGeo, legMat);
            leftLeg.position.set(-0.15, 0.15, 0);
            leftLeg.castShadow = true;
            group.add(leftLeg);
            const rightLeg = new THREE.Mesh(legGeo, legMat);
            rightLeg.position.set(0.15, 0.15, 0);
            rightLeg.castShadow = true;
            group.add(rightLeg);
            
            return group;
        }

        // ENVIRONMENT CREATORS
        function createGround() {
            const ground = new THREE.Mesh(
                new THREE.PlaneGeometry(200, 200, 50, 50),
                new THREE.MeshStandardMaterial({
                    color: 0x5d8c3e, 
                    roughness: 0.95,
                    metalness: 0
                })
            );
            ground.rotation.x = -Math.PI/2;
            ground.receiveShadow = true;
            scene.add(ground);
        }

        function createNPC(x, y, z, color = 0x4a4a4a) {
            const group = new THREE.Group();
            const body = new THREE.Mesh(
                new THREE.CylinderGeometry(0.3, 0.35, 1.2, 16),
                new THREE.MeshStandardMaterial({color: color, roughness: 0.8})
            );
            body.position.y = 0.6;
            body.castShadow = true;
            group.add(body);
            
            const head = new THREE.Mesh(
                new THREE.SphereGeometry(0.25, 16, 16),
                new THREE.MeshStandardMaterial({color: 0xf0c291, roughness: 0.5})
            );
            head.position.y = 1.4;
            head.castShadow = true;
            group.add(head);
            
            // Arms
            const armGeo = new THREE.CylinderGeometry(0.08, 0.08, 0.6, 8);
            const armMat = new THREE.MeshStandardMaterial({color: 0xf0c291, roughness: 0.5});
            const leftArm = new THREE.Mesh(armGeo, armMat);
            leftArm.position.set(-0.4, 0.7, 0);
            leftArm.rotation.z = 0.3;
            leftArm.castShadow = true;
            group.add(leftArm);
            const rightArm = new THREE.Mesh(armGeo, armMat);
            rightArm.position.set(0.4, 0.7, 0);
            rightArm.rotation.z = -0.3;
            rightArm.castShadow = true;
            group.add(rightArm);
            
            // Legs
            const legGeo = new THREE.CylinderGeometry(0.1, 0.09, 0.5, 8);
            const legMat = new THREE.MeshStandardMaterial({color: 0x2c3e50, roughness: 0.8});
            const leftLeg = new THREE.Mesh(legGeo, legMat);
            leftLeg.position.set(-0.15, 0.15, 0);
            leftLeg.castShadow = true;
            group.add(leftLeg);
            const rightLeg = new THREE.Mesh(legGeo, legMat);
            rightLeg.position.set(0.15, 0.15, 0);
            rightLeg.castShadow = true;
            group.add(rightLeg);
            
            group.position.set(x, y, z);
            scene.add(group);
            return group;
        }

        function createHouse(x, y, z, id = 'house') {
            const wall = new THREE.Mesh(
                new THREE.BoxGeometry(12, 6, 12),
                new THREE.MeshStandardMaterial({color: 0xd4a373, roughness: 0.9})
            );
            wall.position.set(x, y + 3, z);
            wall.castShadow = true;
            wall.receiveShadow = true;
            scene.add(wall);
            
            const roof = new THREE.Mesh(
                new THREE.ConeGeometry(9, 4, 4),
                new THREE.MeshStandardMaterial({color: 0x8b4513, roughness: 0.95})
            );
            roof.position.set(x, y + 8, z);
            roof.rotation.y = Math.PI/4;
            roof.castShadow = true;
            scene.add(roof);
            
            // Create door
            const door = createDoor(x, y, z + 6, true, id);
            doors.push(door);
            
            // Door frame
            const doorFrame = new THREE.Mesh(
                new THREE.BoxGeometry(2.5, 4.5, 0.3),
                new THREE.MeshStandardMaterial({color: 0x654321})
            );
            doorFrame.position.set(x, y + 2, z + 6.2);
            scene.add(doorFrame);
            
            buildings.push({x: x, z: z, radius: 7, id: id});
        }

        function createChurch(x, y, z, id = 'church') {
            const main = new THREE.Mesh(
                new THREE.BoxGeometry(25, 15, 35),
                new THREE.MeshStandardMaterial({color: 0xa89968, roughness: 0.9})
            );
            main.position.set(x, y + 7.5, z);
            main.castShadow = true;
            main.receiveShadow = true;
            scene.add(main);
            
            const tower = new THREE.Mesh(
                new THREE.BoxGeometry(5, 25, 5),
                new THREE.MeshStandardMaterial({color: 0x8b7355, roughness: 0.9})
            );
            tower.position.set(x - 12, y + 12.5, z + 12);
            tower.castShadow = true;
            scene.add(tower);
            
            const cross = new THREE.Group();
            const crossV = new THREE.Mesh(
                new THREE.BoxGeometry(0.4, 3, 0.4),
                new THREE.MeshStandardMaterial({
                    color: 0xffd700, 
                    emissive: 0xffd700, 
                    emissiveIntensity: 0.7
                })
            );
            crossV.position.y = 1.5;
            cross.add(crossV);
            const crossH = new THREE.Mesh(
                new THREE.BoxGeometry(2, 0.4, 0.4),
                new THREE.MeshStandardMaterial({
                    color: 0xffd700, 
                    emissive: 0xffd700, 
                    emissiveIntensity: 0.7
                })
            );
            crossH.position.y = 1;
            cross.add(crossH);
            cross.position.set(x - 12, y + 26, z + 12);
            scene.add(cross);
            
            // Create church door (larger)
            const door = createDoor(x, y, z + 17.5, true, id);
            door.scale.set(1.5, 1.2, 1);
            doors.push(door);
            
            // Large door frame
            const doorFrame = new THREE.Mesh(
                new THREE.BoxGeometry(4, 6, 0.3),
                new THREE.MeshStandardMaterial({color: 0x654321})
            );
            doorFrame.position.set(x, y + 3, z + 17.7);
            scene.add(doorFrame);
            
            buildings.push({x: x, z: z + 17, radius: 15, id: id});
        }

        function createDoor(x, y, z, leadsToInterior = false, buildingId = null, leadsToExterior = false) {
            const door = new THREE.Mesh(
                new THREE.BoxGeometry(2, 4, 0.2),
                new THREE.MeshStandardMaterial({
                    color: 0x4a2511,
                    roughness: 0.8
                })
            );
            door.position.set(x, y + 2, z);
            door.castShadow = true;
            
            // Door handle
            const handle = new THREE.Mesh(
                new THREE.SphereGeometry(0.1, 8, 8),
                new THREE.MeshStandardMaterial({
                    color: 0xffd700,
                    metalness: 0.8,
                    roughness: 0.2
                })
            );
            handle.position.set(x + 0.7, y + 2, z + 0.15);
            scene.add(handle);
            
            door.userData = {
                isOpen: false,
                openAngle: Math.PI/2,
                leadsToInterior: leadsToInterior,
                leadsToExterior: leadsToExterior,
                buildingId: buildingId,
                isDoor: true
            };
            
            scene.add(door);
            return door;
        }

        function createTree(x, y, z) {
            const trunk = new THREE.Mesh(
                new THREE.CylinderGeometry(0.3, 0.4, 4, 8),
                new THREE.MeshStandardMaterial({color: 0x6B4423, roughness: 0.98})
            );
            trunk.position.set(x, y + 2, z);
            trunk.castShadow = true;
            trunk.receiveShadow = true;
            scene.add(trunk);
            
            const leaves = new THREE.Mesh(
                new THREE.SphereGeometry(2.5, 12, 12),
                new THREE.MeshStandardMaterial({color: 0x2d5016, roughness: 0.85})
            );
            leaves.position.set(x, y + 5, z);
            leaves.castShadow = true;
            scene.add(leaves);
        }

        function createBush(x, y, z) {
            const bush = new THREE.Mesh(
                new THREE.SphereGeometry(0.8, 8, 8),
                new THREE.MeshStandardMaterial({color: 0x228B22, roughness: 0.9})
            );
            bush.scale.set(1, 0.6, 1);
            bush.position.set(x, y + 0.3, z);
            bush.castShadow = true;
            scene.add(bush);
        }

        function createInteractable(x, y, z, type, label, dialogue = [], effect = null, souls = 0) {
            const obj = new THREE.Mesh(
                new THREE.BoxGeometry(0.6, 0.6, 0.6),
                new THREE.MeshStandardMaterial({
                    color: 0xffd700,
                    emissive: 0xffd700,
                    emissiveIntensity: 0.8,
                    metalness: 0.3,
                    roughness: 0.4
                })
            );
            obj.position.set(x, y, z);
            obj.userData = {
                type: type,
                label: label,
                dialogue: dialogue,
                effect: effect,
                souls: souls,
                floatOffset: Math.random() * Math.PI * 2
            };
            obj.castShadow = true;
            scene.add(obj);
            interactables.push(obj);
            
            // Add glow light
            const light = new THREE.PointLight(0xffd700, 1, 5);
            light.position.copy(obj.position);
            scene.add(light);
            
            return obj;
        }

        function createMiracleEffect(x, y, z, color) {
            const particles = new THREE.Group();
            for(let i = 0; i < 40; i++) {
                const particle = new THREE.Mesh(
                    new THREE.SphereGeometry(0.12, 6, 6),
                    new THREE.MeshBasicMaterial({
                        color: color, 
                        transparent: true, 
                        opacity: 0.9
                    })
                );
                particle.position.set(
                    x + (Math.random() - 0.5) * 3,
                    y + (Math.random() - 0.5) * 3,
                    z + (Math.random() - 0.5) * 3
                );
                particles.add(particle);
            }
            scene.add(particles);
            
            let rot = 0;
            const animate = () => {
                rot += 0.03;
                particles.rotation.y = rot;
                particles.children.forEach((p, i) => {
                    p.position.y += Math.sin(rot + i * 0.5) * 0.02;
                });
                if(rot < 6) requestAnimationFrame(animate);
                else scene.remove(particles);
            };
            animate();
        }

        // CHAPTER LOADERS
        function loadWombBarkingChapter() {
            createGround();
            createHouse(0, 0, -10);
            for(let i = 0; i < 5; i++) createTree(-20 + i * 10, 0, -30);
            for(let i = 0; i < 10; i++) createBush(-15 + Math.random() * 30, 0, -20 + Math.random() * 10);

            createNPC(5, 0, 3, 0x4a2511);
            createInteractable(5, 1, 3, 'talk', 'Talk to William', [
                {speaker: "William (Husband)", text: "Constance, do you hear that sound? It's coming from your womb!"},
                {speaker: "You (Constance)", text: "Yes! The child barks like a dog! He will be a hound of the Lord!"}
            ]);

            createNPC(-5, 0, 5, 0x8b4513);
            createInteractable(-5, 1, 5, 'talk', 'Talk to Neighbor', [
                {speaker: "Neighbor", text: "We heard the barking from outside! This is a miracle from God!"}
            ]);
            
            updateRadar();
        }

        function loadWombHealingChapter() {
            createGround();
            createHouse(0, 0, -10);
            for(let i = 0; i < 5; i++) createTree(-20 + i * 10, 0, -30);

            createNPC(-6, 0, 4, 0x2c3e50);
            createInteractable(-6, 1, 4, 'heal', 'Touch blind woman', [
                {speaker: "Blind Woman", text: "Please, may I touch your womb? I have been blind for years!"},
                {speaker: "You (Constance)", text: "Yes, sister. May God's will be done."},
                {speaker: "Blind Woman", text: "I CAN SEE! Your child healed me! This baby is blessed by God!"}
            ], 'heal', 1);
            
            updateRadar();
        }

        function loadBirthChapter() {
            createGround();
            createHouse(0, 0, -10);
            for(let i = 0; i < 8; i++) createTree(-30 + i * 8, 0, -35);

            createNPC(3, 0, -5, 0xffffff);
            createInteractable(3, 1, -5, 'birth', 'Give Birth', [
                {speaker: "Midwife", text: "The child is born! Look at the holy light surrounding him!"},
                {speaker: "Narrator", text: "January 23, 1350 - Vincent Ferrer is born with miraculous signs."}
            ], 'heal', 0);
            
            updateRadar();
        }

        function loadChildhoodChapter() {
            createGround();
            createHouse(10, 0, -15);
            createChurch(-15, 0, -25);
            for(let i = 0; i < 10; i++) createTree(-25 + i * 5, 0, -40);

            createInteractable(-12, 0.5, -20, 'pray', 'Pray at Church', [
                {speaker: "Young Vincent", text: "Lord, I dedicate my life to You. I will serve You always."}
            ]);

            createNPC(8, 0, -10, 0x4a2511);
            createInteractable(8, 1, -10, 'talk', 'Talk to Father', [
                {speaker: "Father", text: "Vincent, I see the calling of God upon you. You will do great things."}
            ]);
            
            updateRadar();
        }

        function loadDominicanChapter() {
            createGround();
            createChurch(0, 0, -20);
            for(let i = 0; i < 12; i++) createTree(-30 + i * 5, 0, -40);

            for(let i = 0; i < 5; i++) createNPC(-8 + i * 4, 0, -15, 0x000000);

            createInteractable(0, 0.5, -15, 'vows', 'Take Dominican Vows', [
                {speaker: "Vincent Ferrer", text: "I vow poverty, chastity, and obedience. I will preach the Gospel of Christ!"},
                {speaker: "Prior", text: "Welcome to the Order of Preachers, Brother Vincent."}
            ]);
            
            updateRadar();
        }

        function loadPreachingChapter() {
            createGround();
            createChurch(0, 0, -25, 'preaching-church');
            for(let i = 0; i < 20; i++) createTree(-60 + i * 6, 0, -50);

            for(let i = 0; i < 40; i++) {
                createNPC(-20 + Math.random() * 40, 0, -15 + Math.random() * 25, 0x2c3e50);
            }

            for(let i = 0; i < 5; i++) {
                createInteractable(-15 + i * 8, 0.5, -10 + i * 3, 'preach', `Preach to Group ${i + 1}`, [
                    {speaker: "Vincent Ferrer", text: "Repent! The day of judgment draws near! Turn to Christ and be saved!"},
                    {speaker: "Crowd", text: "We believe! We will follow Christ!"}
                ], 'preach', 200);
            }
            
            updateRadar();
        }

        function loadSynagogueChapter() {
            createGround();
            for(let i = 0; i < 20; i++) createNPC(-10 + Math.random() * 20, 0, -20 + Math.random() * 10, 0x000080);

            for(let i = 0; i < 3; i++) {
                createInteractable(-10 + i * 10, 0.5, -15 + i * 5, 'preach', `Preach in Hebrew to Group ${i + 1}`, [
                    {speaker: "Vincent (in Hebrew)", text: "Your Scriptures point to Jesus the Messiah! Isaiah 53 speaks of Him!"},
                    {speaker: "Jews", text: "This man knows our Torah perfectly! We must listen!"}
                ], 'convert', 2666);
            }
            
            updateRadar();
        }

        function loadMosqueChapter() {
            createGround();
            for(let i = 0; i < 25; i++) createNPC(-15 + Math.random() * 30, 0, -20 + Math.random() * 10, 0x006400);

            for(let i = 0; i < 3; i++) {
                createInteractable(-10 + i * 10, 0.5, -15 + i * 5, 'preach', `Preach in Arabic to Group ${i + 1}`, [
                    {speaker: "Vincent (in Arabic)", text: "Isa - Jesus - is the Way, the Truth, and the Life! Come to Him!"},
                    {speaker: "Muslims", text: "No Christian has spoken our language so perfectly! Tell us more!"}
                ], 'convert', 1666);
            }
            
            updateRadar();
        }

        function loadChildRevivalChapter() {
            createGround();
            createHouse(10, 0, -15, 'revival-house');
            for(let i = 0; i < 8; i++) createTree(-30 + i * 8, 0, -35);

            createNPC(-8, 0, 5, 0x000000);
            createInteractable(-8, 0.5, 5, 'heal', 'Raise First Dead Child', [
                {speaker: "Mother", text: "Father Vincent, my baby is dead! Please help!"},
                {speaker: "Vincent", text: "In the name of Jesus Christ, CHILD, ARISE!"},
                {speaker: "Mother", text: "He's alive! He opened his eyes! Praise God!"}
            ], 'heal', 50);

            createNPC(8, 0, 5, 0x8b0000);
            createInteractable(8, 0.5, 5, 'heal', 'Raise Second Dead Child', [
                {speaker: "Mother", text: "Saint Vincent, work your miracle again!"},
                {speaker: "Vincent", text: "Through Christ's power, LIVE AGAIN!"},
                {speaker: "Crowd", text: "He raises the dead! This is a true saint!"}
            ], 'heal', 50);
            
            updateRadar();
        }

        function loadWingsChapter() {
            createGround();
            for(let i = 0; i < 30; i++) createNPC(-15 + Math.random() * 30, 0, -15 + Math.random() * 20, 0x4a4a4a);

            createInteractable(0, 0.5, -20, 'fly', 'Receive Wings and Fly', [
                {speaker: "Vincent", text: "Someone drowns in the harbor! Lord, give me wings!"},
                {speaker: "Narrator", text: "Suddenly, angel wings sprouted from Vincent's back!"},
                {speaker: "Crowd", text: "He flies like an angel! Glory to God!"}
            ], 'heal', 500);
            
            updateRadar();
        }

        function loadResurrectionChapter() {
            createGround();
            for(let i = 0; i < 15; i++) createNPC(-10 + Math.random() * 20, 0, -15 + Math.random() * 10, 0x2c3e50);

            createInteractable(0, 0.5, -15, 'resurrect', 'Command Corpse to Testify', [
                {speaker: "Vincent", text: "In Christ's name, whoever you are in this tomb, ARISE and declare if you are saved or damned!"},
                {speaker: "Dead Man", text: "I am saved by God's mercy. I now return peacefully to rest."},
                {speaker: "Crowd", text: "The dead spoke! This is a miracle from heaven!"}
            ], 'heal', 200);
            
            updateRadar();
        }

        function loadDeathChapter() {
            createGround();
            createHouse(0, 0, -10, 'death-house');
            for(let i = 0; i < 5; i++) createNPC(-6 + i * 3, 0, 0, 0x000000);

            createInteractable(0, 0.5, -8, 'die', 'Receive Last Rites', [
                {speaker: "Vincent", text: "Lord Jesus... into Thy hands... I commend my spirit..."},
                {speaker: "Narrator", text: "The bells rang by themselves. A brilliant light filled the room. The saint entered heaven."}
            ], 'heal', 0);
            
            updateRadar();
        }

        function loadFuneralChapter() {
            createGround();
            createChurch(0, 0, -25, 'funeral-church');
            for(let i = 0; i < 50; i++) createNPC(-20 + Math.random() * 40, 0, -20 + Math.random() * 20, 0x000000);

            createInteractable(-10, 0.5, -15, 'witness', 'Witness Blind Man Healed', [
                {speaker: "Blind Man", text: "I touched the saint's body and now I see! Miracle!"}
            ], 'heal', 0);

            createInteractable(0, 0.5, -15, 'witness', 'Witness Cripple Walk', [
                {speaker: "Cripple", text: "I crawled here but now I walk! Saint Vincent healed me!"}
            ], 'heal', 0);

            createInteractable(10, 0.5, -15, 'witness', 'Witness Deaf Child Hear', [
                {speaker: "Mother", text: "My son can hear! He spoke his first words at the tomb!"}
            ], 'heal', 0);
            
            updateRadar();
        }

        function loadCanonizationChapter() {
            createGround();
            const basilica = new THREE.Mesh(
                new THREE.BoxGeometry(50, 30, 40),
                new THREE.MeshStandardMaterial({color: 0xf5f5dc, roughness: 0.6, metalness: 0.1})
            );
            basilica.position.set(0, 15, -30);
            basilica.castShadow = true;
            basilica.receiveShadow = true;
            scene.add(basilica);
            
            buildings.push({x: 0, z: -30, radius: 28});

            for(let i = 0; i < 100; i++) {
                createNPC(-20 + Math.random() * 40, 0, -5 + Math.random() * 25, 0x8b0000);
            }

            createInteractable(0, 0.5, -20, 'witness', 'Hear Pope\'s Declaration', [
                {speaker: "Pope Callixtus III", text: "We declare that Vincent Ferrer is inscribed in the catalog of Saints!"},
                {speaker: "You (Brother Thomas)", text: "My teacher is now SAINT Vincent Ferrer! I witnessed his holiness!"},
                {speaker: "Narrator", text: "873 miracles confirmed. 25,000 Jews and 8,000 Muslims converted."}
            ]);
            
            updateRadar();
        }

        function onMouseMove(e) {
            if(isMobile) return;
            mouseX = (e.clientX / window.innerWidth) * 2 - 1;
            cameraAngle += e.movementX * 0.003;
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function update(dt) {
            if(gameState !== 'playing' || !playerModel) return;

            const speed = MOVE_SPEED * dt;
            const forward = new THREE.Vector3(Math.sin(cameraAngle), 0, Math.cos(cameraAngle));
            const right = new THREE.Vector3(Math.cos(cameraAngle), 0, -Math.sin(cameraAngle));

            let moveX = 0, moveZ = 0;

            // UNINVERTED CONTROLS - W moves forward in camera direction
            if(keys['w']) {
                moveX += forward.x * speed;
                moveZ += forward.z * speed;
            }
            if(keys['s']) {
                moveX -= forward.x * speed;
                moveZ -= forward.z * speed;
            }
            if(keys['a']) {
                moveX -= right.x * speed;
                moveZ -= right.z * speed;
            }
            if(keys['d']) {
                moveX += right.x * speed;
                moveZ += right.z * speed;
            }

            // Mobile joystick - also uninverted
            if(joyActive) {
                moveX -= right.x * joyDeltaX * speed;
                moveZ -= right.z * joyDeltaX * speed;
                moveX -= forward.x * joyDeltaY * speed;
                moveZ -= forward.z * joyDeltaY * speed;
            }

            // Apply movement with collision detection
            const newX = playerModel.position.x + moveX;
            const newZ = playerModel.position.z + moveZ;

            if(!checkCollision(newX, playerModel.position.z)) {
                playerModel.position.x = newX;
            }
            if(!checkCollision(playerModel.position.x, newZ)) {
                playerModel.position.z = newZ;
            }

            // Rotate player to face movement direction
            if(keys['w'] || keys['s'] || keys['a'] || keys['d'] || joyActive) {
                playerModel.rotation.y = cameraAngle;
            }

            // Camera follow player (third person)
            cameraTarget.copy(playerModel.position);
            const camX = cameraTarget.x - Math.sin(cameraAngle) * CAMERA_DISTANCE;
            const camZ = cameraTarget.z - Math.cos(cameraAngle) * CAMERA_DISTANCE;
            camera.position.x = camX;
            camera.position.y = cameraTarget.y + CAMERA_HEIGHT;
            camera.position.z = camZ;
            camera.lookAt(playerModel.position.x, playerModel.position.y + 1, playerModel.position.z);

            // Check for nearby interactables and doors
            const nearestDoor = findNearestDoor();
            const nearest = findNearestInteractable();
            
            if(nearestDoor) {
                if(nearestDoor.userData.isOpen) {
                    if(nearestDoor.userData.leadsToInterior) {
                        document.getElementById('objective-text').textContent = 'Press E: Enter Building';
                    } else if(nearestDoor.userData.leadsToExterior) {
                        document.getElementById('objective-text').textContent = 'Press E: Exit Building';
                    } else {
                        document.getElementById('objective-text').textContent = CHAPTERS[currentChapter].objective;
                    }
                } else {
                    document.getElementById('objective-text').textContent = 'Press E: Open Door';
                }
            } else if(nearest) {
                document.getElementById('objective-text').textContent = `Press E: ${nearest.userData.label}`;
            } else {
                document.getElementById('objective-text').textContent = CHAPTERS[currentChapter].objective;
            }

            // Animate interactables
            interactables.forEach(obj => {
                obj.position.y = 0.5 + Math.sin(Date.now() * 0.003 + obj.userData.floatOffset) * 0.3;
                obj.rotation.y += 0.03;
            });
        }

        let lastTime = 0;
        function animate(time = 0) {
            requestAnimationFrame(animate);
            const dt = Math.min((time - lastTime) / 1000, 0.05);
            lastTime = time;
            update(dt);
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
